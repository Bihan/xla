


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>PyTorch on XLA Devices &mdash; PyTorch/XLA master documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="_static/pygments.css" type="text/css" /> -->
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <!-- Google Analytics -->
  
  <!-- End Google Analytics -->
  

  
  <script src="_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="active docs-active">
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torcharrow">
                  <span class="dropdown-title">torcharrow</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/data">
                  <span class="dropdown-title">TorchData</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchrec">
                  <span class="dropdown-title">TorchRec</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/torchx/">
                  <span class="dropdown-title">TorchX</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorch’s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
                  <span class="dropdown-title">PyTorch Foundation</span>
                  <p>Learn about the PyTorch foundation</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
                  <span class="dropdown-title">Community Stories</span>
                  <p>Learn how our community solves real, everyday machine learning problems with PyTorch.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/events">
                  <span class="dropdown-title">Events</span>
                  <p>Find events, webinars, and podcasts</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">GitHub</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
                <div class="version">
                  master (1.14 )
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">PyTorch on XLA Devices</a><ul>
<li><a class="reference internal" href="#creating-an-xla-tensor">Creating an XLA Tensor</a></li>
<li><a class="reference internal" href="#xla-tensors-are-pytorch-tensors">XLA Tensors are PyTorch Tensors</a></li>
<li><a class="reference internal" href="#running-models-on-xla-devices">Running Models on XLA Devices</a><ul>
<li><a class="reference internal" href="#running-on-a-single-xla-device">Running on a Single XLA Device</a></li>
<li><a class="reference internal" href="#running-on-multiple-xla-devices-with-multi-processing">Running on Multiple XLA Devices with Multi-processing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id1">XLA Tensor Deep Dive</a><ul>
<li><a class="reference internal" href="#xla-tensors-are-lazy">XLA Tensors are Lazy</a></li>
<li><a class="reference internal" href="#xla-tensors-and-bfloat16">XLA Tensors and bFloat16</a></li>
<li><a class="reference internal" href="#memory-layout">Memory Layout</a></li>
<li><a class="reference internal" href="#moving-xla-tensors-to-and-from-the-cpu">Moving XLA Tensors to and from the CPU</a></li>
<li><a class="reference internal" href="#saving-and-loading-xla-tensors">Saving and Loading XLA Tensors</a></li>
</ul>
</li>
<li><a class="reference internal" href="#further-reading">Further Reading</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pytorch-xla-api">PyTorch/XLA API</a><ul>
<li><a class="reference internal" href="#module-torch_xla.core.xla_model">xla_model</a></li>
<li><a class="reference internal" href="#module-torch_xla.distributed.parallel_loader">distributed</a></li>
<li><a class="reference internal" href="#module-torch_xla.utils.tf_record_reader">utils</a></li>
<li><a class="reference internal" href="#test">test</a></li>
</ul>
</li>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a><ul>
<li><a class="reference internal" href="#perform-a-auto-metrics-analysis">Perform A Auto-Metrics Analysis</a></li>
<li><a class="reference internal" href="#get-a-metrics-report">Get A Metrics Report</a></li>
<li><a class="reference internal" href="#understand-the-metrics-report">Understand The Metrics Report</a></li>
<li><a class="reference internal" href="#performance-profiling">Performance Profiling</a></li>
<li><a class="reference internal" href="#known-performance-caveats">Known Performance Caveats</a></li>
<li><a class="reference internal" href="#xla-tensor-quirks">XLA Tensor Quirks</a></li>
<li><a class="reference internal" href="#more-debugging-tools">More Debugging Tools</a><ul>
<li><a class="reference internal" href="#environment-variables">Environment Variables</a></li>
<li><a class="reference internal" href="#retrieving-stack-traces">Retrieving Stack Traces</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-debug-run-py-to-collect-debug-information">Using debug_run.py To Collect Debug Information</a></li>
<li><a class="reference internal" href="#common-issues">Common Issues</a></li>
</ul>
</li>
<li><a class="reference internal" href="#experimental-pjrt-runtime-support">Experimental PjRt Runtime Support</a><ul>
<li><a class="reference internal" href="#quickstart">Quickstart</a><ul>
<li><a class="reference internal" href="#cpu">CPU</a></li>
<li><a class="reference internal" href="#v4-tpu">v4 TPU</a><ul>
<li><a class="reference internal" href="#pods">Pods</a></li>
</ul>
</li>
<li><a class="reference internal" href="#gpu">GPU</a></li>
</ul>
</li>
<li><a class="reference internal" href="#key-differences-from-xrt">Key differences from XRT</a></li>
<li><a class="reference internal" href="#tpus-v2-v3-vs-v4">TPUs v2/v3 vs v4</a><ul>
<li><a class="reference internal" href="#compatible-examples">Compatible examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pjrt-and-ddp">PjRt and DDP</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-do-distributeddataparallel">How to do <code class="docutils literal notranslate"><span class="pre">DistributedDataParallel</span></code></a><ul>
<li><a class="reference internal" href="#background-motivation">Background / Motivation</a></li>
<li><a class="reference internal" href="#how-to-use-distributeddataparallel">How to use DistributedDataParallel</a></li>
<li><a class="reference internal" href="#benchmarking">Benchmarking</a><ul>
<li><a class="reference internal" href="#resnet50-with-fake-data">Resnet50 with fake data</a></li>
<li><a class="reference internal" href="#mnist-with-fake-data">MNIST with fake data</a></li>
<li><a class="reference internal" href="#mnist-with-real-data">MNIST with real data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#disclaimer">Disclaimer</a></li>
<li><a class="reference internal" href="#fully-sharded-data-parallel-fsdp-in-pytorch-xla">Fully Sharded Data Parallel (FSDP) in PyTorch XLA</a><ul>
<li><a class="reference internal" href="#example-training-scripts-on-mnist-and-imagenet">Example training scripts on MNIST and ImageNet</a><ul>
<li><a class="reference internal" href="#installation">Installation</a></li>
<li><a class="reference internal" href="#clone-pytorch-xla-repo">Clone PyTorch/XLA repo</a></li>
<li><a class="reference internal" href="#train-mnist-on-v3-8-tpu">Train MNIST on v3-8 TPU</a></li>
<li><a class="reference internal" href="#train-imagenet-with-resnet-50-on-v3-8-tpu">Train ImageNet with ResNet-50 on v3-8 TPU</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-training-scripts-on-tpu-pod-with-10-billion-parameters">Example training scripts on TPU pod (with 10 billion parameters)</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#op-lowering-guide">OP Lowering Guide</a><ul>
<li><a class="reference internal" href="#background">Background</a></li>
<li><a class="reference internal" href="#before-you-start">Before you start</a></li>
<li><a class="reference internal" href="#understanding-the-operation">Understanding the operation</a></li>
<li><a class="reference internal" href="#file-structure">File structure</a></li>
<li><a class="reference internal" href="#unit-test">Unit Test</a></li>
<li><a class="reference internal" href="#tips">Tips</a></li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="#">
          
            Docs
          
        </a> &gt;
      </li>

        
      <li>PyTorch on XLA Devices</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
            
            <a href="_sources/index.rst.txt" rel="nofollow"><img src="_static/images/view-page-source-icon.svg"></a>
          
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <div class="section" id="pytorch-on-xla-devices">
<h1>PyTorch on XLA Devices<a class="headerlink" href="#pytorch-on-xla-devices" title="Permalink to this headline">¶</a></h1>
<p>PyTorch runs on XLA devices, like TPUs, with the
<a class="reference external" href="https://github.com/pytorch/xla/">torch_xla package</a>. This document describes
how to run your models on these devices.</p>
<div class="section" id="creating-an-xla-tensor">
<h2>Creating an XLA Tensor<a class="headerlink" href="#creating-an-xla-tensor" title="Permalink to this headline">¶</a></h2>
<p>PyTorch/XLA adds a new <code class="docutils literal notranslate"><span class="pre">xla</span></code> device type to PyTorch. This device type works just
like other PyTorch device types. For example, here’s how to create and
print an XLA tensor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch_xla</span>
<span class="kn">import</span> <span class="nn">torch_xla.core.xla_model</span> <span class="k">as</span> <span class="nn">xm</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
<p>This code should look familiar. PyTorch/XLA uses the same interface as regular
PyTorch with a few additions. Importing <code class="docutils literal notranslate"><span class="pre">torch_xla</span></code> initializes PyTorch/XLA, and
<code class="docutils literal notranslate"><span class="pre">xm.xla_device()</span></code> returns the current XLA device. This may be a CPU or TPU
depending on your environment.</p>
</div>
<div class="section" id="xla-tensors-are-pytorch-tensors">
<h2>XLA Tensors are PyTorch Tensors<a class="headerlink" href="#xla-tensors-are-pytorch-tensors" title="Permalink to this headline">¶</a></h2>
<p>PyTorch operations can be performed on XLA tensors just like CPU or CUDA tensors.</p>
<p>For example, XLA tensors can be added together:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">t0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">())</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">t0</span> <span class="o">+</span> <span class="n">t1</span><span class="p">)</span>
</pre></div>
</div>
<p>Or matrix multiplied:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">t0</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">t1</span><span class="p">))</span>
</pre></div>
</div>
<p>Or used with neural network modules:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">l_in</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">())</span>
<span class="n">linear</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">())</span>
<span class="n">l_out</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">l_in</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">l_out</span><span class="p">)</span>
</pre></div>
</div>
<p>Like other device types, XLA tensors only work with other XLA tensors on the
same device. So code like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">l_in</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">())</span>
<span class="n">linear</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">l_out</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">l_in</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">l_out</span><span class="p">)</span>
<span class="c1"># Input tensor is not an XLA tensor: torch.FloatTensor</span>
</pre></div>
</div>
<p>will throw an error since the <code class="docutils literal notranslate"><span class="pre">torch.nn.Linear</span></code> module is on the CPU.</p>
</div>
<div class="section" id="running-models-on-xla-devices">
<h2>Running Models on XLA Devices<a class="headerlink" href="#running-models-on-xla-devices" title="Permalink to this headline">¶</a></h2>
<p>Building a new PyTorch network or converting an existing one to run on XLA
devices requires only a few lines of XLA-specific code. The following snippets
highlight these lines when running on a single device and multiple devices with XLA
multi-processing.</p>
<div class="section" id="running-on-a-single-xla-device">
<h3>Running on a Single XLA Device<a class="headerlink" href="#running-on-a-single-xla-device" title="Permalink to this headline">¶</a></h3>
<p>The following snippet shows a network training on a single XLA device:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch_xla.core.xla_model</span> <span class="k">as</span> <span class="nn">xm</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">MNIST</span><span class="p">()</span><span class="o">.</span><span class="n">train</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">NLLLoss</span><span class="p">()</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="n">momentum</span><span class="p">)</span>

<span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
  <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
  <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
  <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
  <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

  <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
  <span class="n">xm</span><span class="o">.</span><span class="n">mark_step</span><span class="p">()</span>
</pre></div>
</div>
<p>This snippet highlights how easy it is to switch your model to run on XLA. The
model definition, dataloader, optimizer and training loop can work on any device.
The only XLA-specific code is a couple lines that acquire the XLA device and
mark the step. Calling
<code class="docutils literal notranslate"><span class="pre">xm.mark_step()</span></code> at the end of each training
iteration causes XLA to execute its current graph and update the model’s
parameters. See <a class="reference external" href="#xla-tensor-deep-dive">XLA Tensor Deep Dive</a> for more on
how XLA creates graphs and runs operations.</p>
</div>
<div class="section" id="running-on-multiple-xla-devices-with-multi-processing">
<h3>Running on Multiple XLA Devices with Multi-processing<a class="headerlink" href="#running-on-multiple-xla-devices-with-multi-processing" title="Permalink to this headline">¶</a></h3>
<p>PyTorch/XLA makes it easy to accelerate training by running on multiple XLA
devices. The following snippet shows how:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch_xla.core.xla_model</span> <span class="k">as</span> <span class="nn">xm</span>
<span class="kn">import</span> <span class="nn">torch_xla.distributed.parallel_loader</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">import</span> <span class="nn">torch_xla.distributed.xla_multiprocessing</span> <span class="k">as</span> <span class="nn">xmp</span>

<span class="k">def</span> <span class="nf">_mp_fn</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
  <span class="n">device</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">()</span>
  <span class="n">mp_device_loader</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">MpDeviceLoader</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

  <span class="n">model</span> <span class="o">=</span> <span class="n">MNIST</span><span class="p">()</span><span class="o">.</span><span class="n">train</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
  <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">NLLLoss</span><span class="p">()</span>
  <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="n">momentum</span><span class="p">)</span>

  <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">mp_device_loader</span><span class="p">:</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fn</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">optimizer_step</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="n">xmp</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">_mp_fn</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">())</span>
</pre></div>
</div>
<p>There are three differences between this multi-device snippet and the previous
single device snippet:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">xmp.spawn()</span></code> creates the processes that each run an XLA device.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MpDeviceLoader</span></code> loads the training data onto each device.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">xm.optimizer_step(optimizer)</span></code> consolidates the gradients between cores and issues the XLA device step computation.</p></li>
</ul>
<p>The model definition, optimizer definition and training loop remain the same.</p>
<blockquote>
<div><p><strong>NOTE:</strong> It is important to note that, when using multi-processing, the user can start
retrieving and accessing XLA devices only from within the target function of
<code class="docutils literal notranslate"><span class="pre">xmp.spawn()</span></code> (or any function which has <code class="docutils literal notranslate"><span class="pre">xmp.spawn()</span></code> as parent in the call
stack).</p>
</div></blockquote>
<p>See the
<a class="reference external" href="https://github.com/pytorch/xla/blob/master/test/test_train_mp_mnist.py">full multiprocessing example</a>
for more on training a network on multiple XLA devices with multi-processing.</p>
</div>
</div>
<div class="section" id="id1">
<h2>XLA Tensor Deep Dive<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>Using XLA tensors and devices requires changing only a few lines of code. But
even though XLA tensors act a lot like CPU and CUDA tensors, their internals are
different. This section describes what makes XLA tensors unique.</p>
<div class="section" id="xla-tensors-are-lazy">
<h3>XLA Tensors are Lazy<a class="headerlink" href="#xla-tensors-are-lazy" title="Permalink to this headline">¶</a></h3>
<p>CPU and CUDA tensors launch operations immediately or <span class="raw-html-m2r"><b>eagerly</b></span>. XLA tensors,
on the other hand, are <span class="raw-html-m2r"><b>lazy</b></span>. They record operations in a graph until the
results are needed. Deferring execution like this lets XLA optimize it. A graph
of multiple separate operations might be fused into a single optimized
operation, for example.</p>
<p>Lazy execution is generally invisible to the caller. PyTorch/XLA automatically
constructs the graphs, sends them to XLA devices, and synchronizes when
copying data between an XLA device and the CPU. Inserting a barrier when
taking an optimizer step explicitly synchronizes the CPU and the XLA device. For
more information about our lazy tensor design, you can read <a class="reference external" href="https://arxiv.org/pdf/2102.13267.pdf">this paper</a>.</p>
</div>
<div class="section" id="xla-tensors-and-bfloat16">
<h3>XLA Tensors and bFloat16<a class="headerlink" href="#xla-tensors-and-bfloat16" title="Permalink to this headline">¶</a></h3>
<p>PyTorch/XLA can use the
<a class="reference external" href="https://en.wikipedia.org/wiki/Bfloat16_floating-point_format">bfloat16</a>
datatype when running on TPUs. In fact, PyTorch/XLA handles float types
(<code class="docutils literal notranslate"><span class="pre">torch.float</span></code> and <code class="docutils literal notranslate"><span class="pre">torch.double</span></code>) differently on TPUs. This behavior is
controlled by the <code class="docutils literal notranslate"><span class="pre">XLA_USE_BF16</span></code> and <code class="docutils literal notranslate"><span class="pre">XLA_DOWNCAST_BF16</span></code> environment variable:</p>
<ul class="simple">
<li><p>By default both <code class="docutils literal notranslate"><span class="pre">torch.float</span></code> and <code class="docutils literal notranslate"><span class="pre">torch.double</span></code> are
<code class="docutils literal notranslate"><span class="pre">torch.float</span></code> on TPUs.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">XLA_USE_BF16</span></code> is set, then <code class="docutils literal notranslate"><span class="pre">torch.float</span></code> and <code class="docutils literal notranslate"><span class="pre">torch.double</span></code> are both
<code class="docutils literal notranslate"><span class="pre">bfloat16</span></code> on TPUs.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">XLA_DOWNCAST_BF16</span></code> is set, then <code class="docutils literal notranslate"><span class="pre">torch.float</span></code> is <code class="docutils literal notranslate"><span class="pre">bfloat16</span></code> on TPUs and <code class="docutils literal notranslate"><span class="pre">torch.double</span></code> is <code class="docutils literal notranslate"><span class="pre">float32</span></code> on TPUs.</p></li>
<li><p>If a PyTorch tensor has <code class="docutils literal notranslate"><span class="pre">torch.bfloat16</span></code> data type, this will be directly
mapped to the TPU <code class="docutils literal notranslate"><span class="pre">bfloat16</span></code> (XLA <code class="docutils literal notranslate"><span class="pre">BF16</span></code> primitive type).</p></li>
</ul>
<p>Developers should note that <em>XLA tensors on TPUs will always report their PyTorch datatype</em> regardless of
the actual datatype they’re using. This conversion is automatic and opaque.
If an XLA tensor on a TPU is moved back to the CPU it will be converted
from its actual datatype to its PyTorch datatype. Depending on how your code operates, this conversion triggered by
the type of processing unit can be important.</p>
</div>
<div class="section" id="memory-layout">
<h3>Memory Layout<a class="headerlink" href="#memory-layout" title="Permalink to this headline">¶</a></h3>
<p>The internal data representation of XLA tensors is opaque to the user. They
do not expose their storage and they always appear to be contiguous, unlike
CPU and CUDA tensors. This allows XLA to adjust a tensor’s memory layout for
better performance.</p>
</div>
<div class="section" id="moving-xla-tensors-to-and-from-the-cpu">
<h3>Moving XLA Tensors to and from the CPU<a class="headerlink" href="#moving-xla-tensors-to-and-from-the-cpu" title="Permalink to this headline">¶</a></h3>
<p>XLA tensors can be moved from the CPU to an XLA device and from an XLA device
to the CPU. If a view is moved then the data its viewing is also copied to the
other device and the view relationship is not preserved. Put another way,
once data is copied to another device it has no relationship with its
previous device or any tensors on it. Again, depending on how your code operates,
appreciating and accommodating this transition can be important.</p>
</div>
<div class="section" id="saving-and-loading-xla-tensors">
<h3>Saving and Loading XLA Tensors<a class="headerlink" href="#saving-and-loading-xla-tensors" title="Permalink to this headline">¶</a></h3>
<p>XLA tensors should be moved to the CPU before saving, as in the following
snippet:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch_xla</span>
<span class="kn">import</span> <span class="nn">torch_xla.core.xla_model</span> <span class="k">as</span> <span class="nn">xm</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">()</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">tensors</span> <span class="o">=</span> <span class="p">(</span><span class="n">t0</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="n">t1</span><span class="o">.</span><span class="n">cpu</span><span class="p">())</span>

<span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="s1">&#39;tensors.pt&#39;</span><span class="p">)</span>

<span class="n">tensors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;tensors.pt&#39;</span><span class="p">)</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">tensors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</pre></div>
</div>
<p>This lets you put the loaded tensors on any available device, not just the one on which they were initialized.</p>
<p>Per the above note on moving XLA tensors to the CPU, care must be taken when
working with views. Instead of saving views it is recommended that you recreate
them after the tensors have been loaded and moved to their destination device(s).</p>
<p>A utility API is provided to save data by taking care of previously moving it
to CPU:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch_xla</span>
<span class="kn">import</span> <span class="nn">torch_xla.core.xla_model</span> <span class="k">as</span> <span class="nn">xm</span>

<span class="n">xm</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
<p>In case of multiple devices, the above API will only save the data for the master
device ordinal (0).</p>
<p>In case where memory is limited compared to the size of the model parameters, an
API is provided that reduces the memory footprint on the host:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch_xla.utils.serialization</span> <span class="k">as</span> <span class="nn">xser</span>

<span class="n">xser</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
<p>This API streams XLA tensors to CPU one at a time, reducing the amount of host
memory used, but it requires a matching load API to restore:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch_xla.utils.serialization</span> <span class="k">as</span> <span class="nn">xser</span>

<span class="n">state_dict</span> <span class="o">=</span> <span class="n">xser</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">state_dict</span><span class="p">)</span>
</pre></div>
</div>
<p>Directly saving XLA tensors is possible but not recommended. XLA
tensors are always loaded back to the device they were saved from, and if
that device is unavailable the load will fail. PyTorch/XLA, like all of PyTorch,
is under active development and this behavior may change in the future.</p>
</div>
</div>
<div class="section" id="further-reading">
<h2>Further Reading<a class="headerlink" href="#further-reading" title="Permalink to this headline">¶</a></h2>
<p>Additional documentation is available at the
<a class="reference external" href="https://github.com/pytorch/xla/">PyTorch/XLA repo</a>. More examples of running
networks on TPUs are available
<a class="reference external" href="https://github.com/pytorch-tpu/examples">here</a>.</p>
</div>
</div>
<div class="section" id="pytorch-xla-api">
<h1>PyTorch/XLA API<a class="headerlink" href="#pytorch-xla-api" title="Permalink to this headline">¶</a></h1>
<div class="section" id="module-torch_xla.core.xla_model">
<span id="xla-model"></span><h2>xla_model<a class="headerlink" href="#module-torch_xla.core.xla_model" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="torch_xla.core.xla_model.xla_device">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">xla_device</code><span class="sig-paren">(</span><em class="sig-param">n=None</em>, <em class="sig-param">devkind=None</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#xla_device"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.xla_device" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a given instance of an XLA device.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>n</strong> (<em>python:int</em><em>, </em><em>optional</em>) – The specific instance (ordinal) to be returned. If
specified, the specific XLA device instance will be returned. Otherwise
the first device of <cite>devkind</cite> will be returned.</p></li>
<li><p><strong>devkind</strong> (<em>string...</em><em>, </em><em>optional</em>) – If specified, one of <cite>TPU</cite>, <cite>GPU</cite> or <cite>CPU</cite>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A <cite>torch.device</cite> with the requested instance.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.get_xla_supported_devices">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">get_xla_supported_devices</code><span class="sig-paren">(</span><em class="sig-param">devkind=None</em>, <em class="sig-param">max_devices=None</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#get_xla_supported_devices"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.get_xla_supported_devices" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a list of supported devices of a given kind.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>devkind</strong> (<em>string...</em><em>, </em><em>optional</em>) – If specified, one of <cite>TPU</cite>, <cite>GPU</cite> or <cite>CPU</cite>
(the ‘GPU’ XLA device is currently not implemented).</p></li>
<li><p><strong>max_devices</strong> (<em>python:int</em><em>, </em><em>optional</em>) – The maximum number of devices to be returned of
that kind.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The list of device strings.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.xla_device_hw">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">xla_device_hw</code><span class="sig-paren">(</span><em class="sig-param">device</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#xla_device_hw"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.xla_device_hw" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the hardware type of the given device.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>device</strong> (<em>string</em><em> or </em><em>torch.device</em>) – The xla device that will be mapped to the
real device.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A string representation of the hardware type (<cite>CPU</cite>, <cite>TPU</cite>, <cite>GPU</cite>) of the
given device.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.get_ordinal">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">get_ordinal</code><span class="sig-paren">(</span><em class="sig-param">defval=0</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#get_ordinal"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.get_ordinal" title="Permalink to this definition">¶</a></dt>
<dd><p>Retrieves the replication ordinal of the current thread.</p>
<p>The ordinals range from 0 to <cite>xrt_world_size()</cite> minus 1.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>defval</strong> (<em>python:int</em><em>, </em><em>optional</em>) – The default value to be returned in case there is no
replication information available. Ignored for PjRt.
Default: 0</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The replication ordinal of the current thread.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.get_local_ordinal">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">get_local_ordinal</code><span class="sig-paren">(</span><em class="sig-param">defval=0</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#get_local_ordinal"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.get_local_ordinal" title="Permalink to this definition">¶</a></dt>
<dd><p>Retrieves the replication local ordinal of the current thread.</p>
<p>The local ordinals range from 0 to the number of local devices minus 1.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>defval</strong> (<em>python:int</em><em>, </em><em>optional</em>) – The default value to be returned in case there is no
replication information available. Ignored for PjRt.
Default: 0</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The replication local ordinal of the current thread.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.is_master_ordinal">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">is_master_ordinal</code><span class="sig-paren">(</span><em class="sig-param">local=True</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#is_master_ordinal"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.is_master_ordinal" title="Permalink to this definition">¶</a></dt>
<dd><p>Checks whether the current process is the master ordinal (0).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>local</strong> (<em>bool</em>) – Whether the local or global master ordinal should be checked.
In case of multi-host replication, there is only one global master ordinal
(host 0, device 0), while there are NUM_HOSTS local master ordinals.
Default: True</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A boolean indicating whether the current process is the master ordinal.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.xrt_world_size">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">xrt_world_size</code><span class="sig-paren">(</span><em class="sig-param">defval=1</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#xrt_world_size"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.xrt_world_size" title="Permalink to this definition">¶</a></dt>
<dd><p>Retrieves the number of devices which is taking part of the replication.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>defval</strong> (<em>python:int</em><em>, </em><em>optional</em>) – The default value to be returned in case there is no
replication information available.
Default: 1</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The number of devices which is taking part of the replication.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.all_reduce">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">all_reduce</code><span class="sig-paren">(</span><em class="sig-param">reduce_type</em>, <em class="sig-param">inputs</em>, <em class="sig-param">scale=1.0</em>, <em class="sig-param">groups=None</em>, <em class="sig-param">cctx=None</em>, <em class="sig-param">pin_layout=True</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#all_reduce"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.all_reduce" title="Permalink to this definition">¶</a></dt>
<dd><p>Performs an inplace reduce operation on the input tensor(s).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>reduce_type</strong> (<em>string</em>) – One of <code class="docutils literal notranslate"><span class="pre">xm.REDUCE_SUM</span></code>, <code class="docutils literal notranslate"><span class="pre">xm.REDUCE_MUL</span></code>,
<code class="docutils literal notranslate"><span class="pre">xm.REDUCE_AND</span></code>, <code class="docutils literal notranslate"><span class="pre">xm.REDUCE_OR</span></code>, <code class="docutils literal notranslate"><span class="pre">xm.REDUCE_MIN</span></code> and
<code class="docutils literal notranslate"><span class="pre">xm.REDUCE_MAX</span></code>.</p></li>
<li><p><strong>inputs</strong> – Either a single <cite>torch.Tensor</cite> or a list of <cite>torch.Tensor</cite> to
perform the all reduce op to.</p></li>
<li><p><strong>scale</strong> (<em>python:float</em>) – A default scaling value to be applied after the reduce.
Default: 1.0</p></li>
<li><p><strong>groups</strong> (<em>list</em><em>, </em><em>optional</em>) – <p>A list of list, representing the replica groups for
the <cite>all_reduce()</cite> operation. Example: <cite>[[0, 1, 2, 3], [4, 5, 6, 7]]</cite></p>
<blockquote>
<div><p>defines two groups, one with the <cite>[0, 1, 2, 3]</cite> replicas and one with
the <cite>[4, 5, 6, 7]</cite> replicas. If <cite>None</cite> there will be only one group with
all the replicas in it.</p>
</div></blockquote>
</p></li>
<li><p><strong>pin_layout</strong> (<em>bool</em><em>, </em><em>optional</em>) – whether to pin the layout for this communication op.
Layout pining can prevent potential data corruption when each process that
participate in the communication has slightly different program, but it might
cause some xla compiation to fail. Unpin the layout when you see error message
like “HloModule has a mix of layout constrained”.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>If a single <cite>torch.Tensor</cite> is passed, the return value is a <cite>torch.Tensor</cite>
holding the reduced value (across the replicas). If a list/tuple is passed,
this function performs an inplace all-reduce op on the input tensors, and
returns the list/tuple itself.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.all_gather">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">all_gather</code><span class="sig-paren">(</span><em class="sig-param">value</em>, <em class="sig-param">dim=0</em>, <em class="sig-param">groups=None</em>, <em class="sig-param">output=None</em>, <em class="sig-param">pin_layout=True</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#all_gather"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.all_gather" title="Permalink to this definition">¶</a></dt>
<dd><p>Performs an all-gather operation along a given dimension.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>value</strong> (<em>torch.Tensor</em>) – The input tensor.</p></li>
<li><p><strong>dim</strong> (<em>python:int</em>) – The gather dimension.
Default: 0</p></li>
<li><p><strong>groups</strong> (<em>list</em><em>, </em><em>optional</em>) – <p>A list of list, representing the replica groups for
the <cite>all_gather()</cite> operation. Example: <cite>[[0, 1, 2, 3], [4, 5, 6, 7]]</cite></p>
<blockquote>
<div><p>defines two groups, one with the <cite>[0, 1, 2, 3]</cite> replicas and one with
the <cite>[4, 5, 6, 7]</cite> replicas. If <cite>None</cite> there will be only one group with
all the replicas in it.</p>
</div></blockquote>
</p></li>
<li><p><strong>output</strong> (<em>torch.Tensor</em>) – Optional output tensor.</p></li>
<li><p><strong>pin_layout</strong> (<em>bool</em><em>, </em><em>optional</em>) – whether to pin the layout for this communication op.
Layout pining can prevent potential data corruption when each process that
participate in the communication has slightly different program, but it might
cause some xla compiation to fail. Unpin the layout when you see error message
like “HloModule has a mix of layout constrained”.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A tensor which has, in the <code class="docutils literal notranslate"><span class="pre">dim</span></code> dimension, all the values from the
participating replicas.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.all_to_all">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">all_to_all</code><span class="sig-paren">(</span><em class="sig-param">value</em>, <em class="sig-param">split_dimension</em>, <em class="sig-param">concat_dimension</em>, <em class="sig-param">split_count</em>, <em class="sig-param">groups=None</em>, <em class="sig-param">pin_layout=True</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#all_to_all"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.all_to_all" title="Permalink to this definition">¶</a></dt>
<dd><p>Performs an XLA <cite>AllToAll()</cite> operation on the input tensor.</p>
<p>See: <a class="reference external" href="https://www.tensorflow.org/xla/operation_semantics#alltoall">https://www.tensorflow.org/xla/operation_semantics#alltoall</a></p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>value</strong> (<em>torch.Tensor</em>) – The input tensor.</p></li>
<li><p><strong>split_dimension</strong> (<em>python:int</em>) – The dimension upon which the split should happen.</p></li>
<li><p><strong>concat_dimension</strong> (<em>python:int</em>) – The dimension upon which the concat should happen.</p></li>
<li><p><strong>split_count</strong> (<em>python:int</em>) – The split count.</p></li>
<li><p><strong>groups</strong> (<em>list</em><em>, </em><em>optional</em>) – <p>A list of list, representing the replica groups for
the <cite>all_reduce()</cite> operation. Example: <cite>[[0, 1, 2, 3], [4, 5, 6, 7]]</cite></p>
<blockquote>
<div><p>defines two groups, one with the <cite>[0, 1, 2, 3]</cite> replicas and one with
the <cite>[4, 5, 6, 7]</cite> replicas. If <cite>None</cite> there will be only one group with
all the replicas in it.</p>
</div></blockquote>
</p></li>
<li><p><strong>pin_layout</strong> (<em>bool</em><em>, </em><em>optional</em>) – whether to pin the layout for this communication op.
Layout pining can prevent potential data corruption when each process that
participate in the communication has slightly different program, but it might
cause some xla compiation to fail. Unpin the layout when you see error message
like “HloModule has a mix of layout constrained”.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The result <cite>torch.Tensor</cite> of the <cite>all_to_all()</cite> operation.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.add_step_closure">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">add_step_closure</code><span class="sig-paren">(</span><em class="sig-param">closure</em>, <em class="sig-param">args=()</em>, <em class="sig-param">run_async=False</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#add_step_closure"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.add_step_closure" title="Permalink to this definition">¶</a></dt>
<dd><p>Adds a closure to the list of the ones to be run at the end of the step.</p>
<p>Many times during model training there is the need to print/report (print to
console, post to tensorboard, etc…) information which require the content of
intermediary tensors to be inspected.
Inspecting different tensors content in different points of the model code
requires many executions and typically causes performance issues.
Adding a step closure will ensure that it will be run after the barrier, when
all the live tensors will be already materialized to device data.
Live tensors which will include the ones captured by the closure arguments.
So using <cite>add_step_closure()</cite> will ensure a single execution will be
performed, even when multiple closures are queued, requiring multiple tensors
to be inspected.
Step closures will be run sequentially in the order they have been queued.
Note that even though using this API the execution will be optimized, it is
advised to throttle the printing/reporting events once every N steps.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>closure</strong> (<em>callable</em>) – The function to be called.</p></li>
<li><p><strong>args</strong> (<em>tuple</em>) – The arguments to be passed to the closure.</p></li>
<li><p><strong>run_async</strong> – If True, run the closure asynchronously.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.wait_device_ops">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">wait_device_ops</code><span class="sig-paren">(</span><em class="sig-param">devices=[]</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#wait_device_ops"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.wait_device_ops" title="Permalink to this definition">¶</a></dt>
<dd><p>Waits for all the async operations on the given devices to complete.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>devices</strong> (<em>string...</em><em>, </em><em>optional</em>) – The devices whose async ops need to be waited
for. If empty, all the local devices will be waited for.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.optimizer_step">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">optimizer_step</code><span class="sig-paren">(</span><em class="sig-param">optimizer</em>, <em class="sig-param">barrier=False</em>, <em class="sig-param">optimizer_args={}</em>, <em class="sig-param">groups=None</em>, <em class="sig-param">pin_layout=True</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#optimizer_step"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.optimizer_step" title="Permalink to this definition">¶</a></dt>
<dd><p>Run the provided optimizer step and issue the XLA device step computation.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>optimizer</strong> (<code class="xref py py-class docutils literal notranslate"><span class="pre">torch.Optimizer</span></code>) – The <cite>torch.Optimizer</cite> instance whose
<cite>step()</cite> function needs to be called. The <cite>step()</cite> function will be called
with the <cite>optimizer_args</cite> named arguments.</p></li>
<li><p><strong>barrier</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether the XLA tensor barrier should be issued in
this API. If using the PyTorch XLA <cite>ParallelLoader</cite> or <cite>DataParallel</cite>
support, this is not necessary as the barrier will be issued by the XLA
data loader iterator <cite>next()</cite> call.
Default: False</p></li>
<li><p><strong>optimizer_args</strong> (<em>dict</em><em>, </em><em>optional</em>) – Named arguments dictionary for the
<cite>optimizer.step()</cite> call.</p></li>
<li><p><strong>groups</strong> (<em>list</em><em>, </em><em>optional</em>) – <p>A list of list, representing the replica groups for
the <cite>all_reduce()</cite> operation. Example: <cite>[[0, 1, 2, 3], [4, 5, 6, 7]]</cite></p>
<blockquote>
<div><p>defines two groups, one with the <cite>[0, 1, 2, 3]</cite> replicas and one with
the <cite>[4, 5, 6, 7]</cite> replicas. If <cite>None</cite> there will be only one group with
all the replicas in it.</p>
</div></blockquote>
</p></li>
<li><p><strong>pin_layout</strong> (<em>bool</em><em>, </em><em>optional</em>) – whether to pin the layout when reducing gradients.
See <cite>xm.all_reduce</cite> for details.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The same value returned by the <cite>optimizer.step()</cite> call.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.save">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">save</code><span class="sig-paren">(</span><em class="sig-param">data</em>, <em class="sig-param">file_or_path</em>, <em class="sig-param">master_only=True</em>, <em class="sig-param">global_master=False</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#save"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.save" title="Permalink to this definition">¶</a></dt>
<dd><p>Saves the input data into a file.</p>
<p>The saved data is transferred to PyTorch CPU device before being saved, so a
following <cite>torch.load()</cite> will load CPU data.
Care must be taken when working with views. Instead of saving views it’s
recommended that you recreate them after the tensors have been loaded and
moved to their destination device(s).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data</strong> – The input data to be saved. Any nested combination of Python objects
(list, tuples, sets, dicts, …).</p></li>
<li><p><strong>file_or_path</strong> – The destination for the data saving operation. Either a file
path or a Python file object. If <cite>master_only</cite> is <code class="docutils literal notranslate"><span class="pre">False</span></code> the path or
file objects must point to different destinations as otherwise all the
writes from the same host will override each other.</p></li>
<li><p><strong>master_only</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether only the master device should save the
data. If False, the <cite>file_or_path</cite> argument should be a different file or
path for each of the ordinals taking part to the replication, otherwise
all the replicas on the same host will be writing to the same location.
Default: True</p></li>
<li><p><strong>global_master</strong> (<em>bool</em><em>, </em><em>optional</em>) – When <code class="docutils literal notranslate"><span class="pre">master_only</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code> this flag
controls whether every host’s master (if <code class="docutils literal notranslate"><span class="pre">global_master</span></code> is <code class="docutils literal notranslate"><span class="pre">False</span></code>)
saves the content, or only the global master (ordinal 0).
Default: False</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.rendezvous">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">rendezvous</code><span class="sig-paren">(</span><em class="sig-param">tag</em>, <em class="sig-param">payload=b''</em>, <em class="sig-param">replicas=[]</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#rendezvous"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.rendezvous" title="Permalink to this definition">¶</a></dt>
<dd><p>Waits for all the mesh clients to reach the named rendezvous.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>tag</strong> (<em>string</em>) – The name of the rendezvous to join.</p></li>
<li><p><strong>payload</strong> (<em>bytes</em><em>, </em><em>optional</em>) – The payload to be sent to the rendezvous.</p></li>
<li><p><strong>replicas</strong> (<em>list</em><em>, </em><em>python:int</em>) – The replica ordinals taking part of the rendezvous.
Empty means all replicas in the mesh.
Default: []</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The payloads exchanged by all the other cores, with the payload of core
ordinal <cite>i</cite> at position <cite>i</cite> in the returned tuple.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.do_on_ordinals">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">do_on_ordinals</code><span class="sig-paren">(</span><em class="sig-param">target</em>, <em class="sig-param">data=()</em>, <em class="sig-param">ordinals=(0</em>, <em class="sig-param">)</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#do_on_ordinals"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.do_on_ordinals" title="Permalink to this definition">¶</a></dt>
<dd><p>Runs a function only on a given set of ordinals.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>target</strong> (<em>callable</em>) – The function to be run on <cite>ordinals</cite>.</p></li>
<li><p><strong>data</strong> – Any input data for the <cite>target</cite> function which contains tensors. All
the XLA tensors used by the <cite>target</cite> function must be passed in this
argument. Every other data used by the function can be captured by the
Python interpreter as usual.
Default: ()</p></li>
<li><p><strong>ordinals</strong> (<em>list</em><em>, </em><em>python:int</em>) – The list/set of ordinals where the <cite>target</cite> function
should run.
Default: (0,)</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>In the ordinals that ran the <cite>target</cite> function, the function return value,
otherwise <cite>None</cite>.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.mesh_reduce">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">mesh_reduce</code><span class="sig-paren">(</span><em class="sig-param">tag</em>, <em class="sig-param">data</em>, <em class="sig-param">reduce_fn</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#mesh_reduce"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.mesh_reduce" title="Permalink to this definition">¶</a></dt>
<dd><p>Performs an out-of-graph client mesh reduction.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>tag</strong> (<em>string</em>) – The name of the rendezvous to join.</p></li>
<li><p><strong>data</strong> – The data to be reduced. The <cite>reduce_fn</cite> callable will receive a list
with the copies of the same data coming from all the mesh client processes
(one per core).</p></li>
<li><p><strong>reduce_fn</strong> (<em>callable</em>) – A function which receives a list of <cite>data</cite>-like
objects and returns the reduced result.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The reduced value.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.set_rng_state">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">set_rng_state</code><span class="sig-paren">(</span><em class="sig-param">seed</em>, <em class="sig-param">device=None</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#set_rng_state"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.set_rng_state" title="Permalink to this definition">¶</a></dt>
<dd><p>Sets the random number generator state.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>seed</strong> (<em>python:integer</em>) – The state to be set.</p></li>
<li><p><strong>device</strong> (<em>string</em><em>, </em><em>optional</em>) – The device where the RNG state needs to be set.
If missing the default device seed will be set.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.get_rng_state">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">get_rng_state</code><span class="sig-paren">(</span><em class="sig-param">device=None</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#get_rng_state"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.get_rng_state" title="Permalink to this definition">¶</a></dt>
<dd><p>Gets the current running random number generator state.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>device</strong> (<em>string</em><em>, </em><em>optional</em>) – The device whose RNG state needs to be retrieved.
If missing the default device seed will be set.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The RNG state, as integer.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.xla_model.get_memory_info">
<code class="sig-prename descclassname">torch_xla.core.xla_model.</code><code class="sig-name descname">get_memory_info</code><span class="sig-paren">(</span><em class="sig-param">device</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/xla_model.html#get_memory_info"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.xla_model.get_memory_info" title="Permalink to this definition">¶</a></dt>
<dd><p>Retrieves the device memory information.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>device</strong> (<em>string</em>) – The device whose memory information are requested.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A dictionary with <cite>kb_free</cite> (free memory in KB) and <cite>kb_total</cite> (total
memory in KB) keys.</p>
</dd>
</dl>
</dd></dl>

<span class="target" id="module-torch_xla.core.functions"></span><dl class="function">
<dt id="torch_xla.core.functions.all_reduce">
<code class="sig-prename descclassname">torch_xla.core.functions.</code><code class="sig-name descname">all_reduce</code><span class="sig-paren">(</span><em class="sig-param">reduce_type</em>, <em class="sig-param">value</em>, <em class="sig-param">scale=1.0</em>, <em class="sig-param">groups=None</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/functions.html#all_reduce"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.functions.all_reduce" title="Permalink to this definition">¶</a></dt>
<dd><p>Performs an inplace reduce operation on the input tensor.</p>
<p>This is the same as <cite>xm.all_reduce()</cite> but supports autograd differentiation.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>reduce_type</strong> (<em>string</em>) – One of <code class="docutils literal notranslate"><span class="pre">REDUCE_SUM</span></code>, <code class="docutils literal notranslate"><span class="pre">REDUCE_MUL</span></code>, <code class="docutils literal notranslate"><span class="pre">REDUCE_AND</span></code>,
<code class="docutils literal notranslate"><span class="pre">REDUCE_OR</span></code>, <code class="docutils literal notranslate"><span class="pre">REDUCE_MIN</span></code> and <code class="docutils literal notranslate"><span class="pre">REDUCE_MAX</span></code>.</p></li>
<li><p><strong>value</strong> (<em>torch.Tensor</em>) – The to perform the all reduce op to.</p></li>
<li><p><strong>scale</strong> (<em>python:float</em>) – A default scaling value to be applied after the reduce.
Default: 1.0</p></li>
<li><p><strong>groups</strong> (<em>list</em><em>, </em><em>optional</em>) – <p>A list of list, representing the replica groups for
the <cite>all_reduce()</cite> operation. Example: <cite>[[0, 1, 2, 3], [4, 5, 6, 7]]</cite></p>
<blockquote>
<div><p>defines two groups, one with the <cite>[0, 1, 2, 3]</cite> replicas and one with
the <cite>[4, 5, 6, 7]</cite> replicas. If <cite>None</cite> there will be only one group with
all the replicas in it.</p>
</div></blockquote>
</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The reduced value across the selected replicas.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.functions.all_gather">
<code class="sig-prename descclassname">torch_xla.core.functions.</code><code class="sig-name descname">all_gather</code><span class="sig-paren">(</span><em class="sig-param">value</em>, <em class="sig-param">dim=0</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/functions.html#all_gather"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.functions.all_gather" title="Permalink to this definition">¶</a></dt>
<dd><p>Performs an all-gather operation along a given dimension.</p>
<p>This is the same as <cite>xm.all_gather()</cite> but supports autograd differentiation.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>value</strong> (<em>torch.Tensor</em>) – The input tensor.</p></li>
<li><p><strong>dim</strong> (<em>python:int</em>) – The gather dimension.
Default: 0</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A tensor which has, in the <code class="docutils literal notranslate"><span class="pre">dim</span></code> dimension, all the values from the
participating replicas.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.core.functions.nms">
<code class="sig-prename descclassname">torch_xla.core.functions.</code><code class="sig-name descname">nms</code><span class="sig-paren">(</span><em class="sig-param">boxes</em>, <em class="sig-param">scores</em>, <em class="sig-param">score_threshold</em>, <em class="sig-param">iou_threshold</em>, <em class="sig-param">output_size</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/core/functions.html#nms"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.core.functions.nms" title="Permalink to this definition">¶</a></dt>
<dd><p>Performs a Non Maximal Suppression operation.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>boxes</strong> (<em>torch.Tensor</em>) – A <cite>torch.Tensor</cite> of shape <cite>[N, 4]</cite> listing the boxes
coordinates in <cite>(y0, x0, y1, x1)</cite> form.</p></li>
<li><p><strong>scores</strong> (<em>torch.Tensor</em>) – A <cite>torch.Tensor</cite> of shape <cite>[N]</cite> listing the scores
of each box.</p></li>
<li><p><strong>score_threshold</strong> (<em>torch.Tensor</em>) – The minimum score for a box to qualify as
valid.</p></li>
<li><p><strong>iou_threshold</strong> (<em>torch.Tensor</em>) – The minimum IOU (Intersection Over Union)
score to trigger overlap logic.</p></li>
<li><p><strong>output_size</strong> (<em>python:int</em>) – The maximum number of returned indices (must be lower or
equal to N).</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A tuple of <cite>torch.Tensor</cite> with the first element being the selected box
indices, and the second element being the number of valid boxes.</p>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="module-torch_xla.distributed.parallel_loader">
<span id="distributed"></span><h2>distributed<a class="headerlink" href="#module-torch_xla.distributed.parallel_loader" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="torch_xla.distributed.parallel_loader.ParallelLoader">
<em class="property">class </em><code class="sig-prename descclassname">torch_xla.distributed.parallel_loader.</code><code class="sig-name descname">ParallelLoader</code><span class="sig-paren">(</span><em class="sig-param">loader</em>, <em class="sig-param">devices</em>, <em class="sig-param">batchdim=0</em>, <em class="sig-param">batches_per_execution=1</em>, <em class="sig-param">loader_prefetch_size=8</em>, <em class="sig-param">device_prefetch_size=4</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/distributed/parallel_loader.html#ParallelLoader"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.distributed.parallel_loader.ParallelLoader" title="Permalink to this definition">¶</a></dt>
<dd><p>Wraps an existing PyTorch DataLoader with background data upload.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>loader</strong> (<code class="xref py py-class docutils literal notranslate"><span class="pre">torch.utils.data.DataLoader</span></code>) – The PyTorch DataLoader to be
wrapped.</p></li>
<li><p><strong>devices</strong> (<cite>torch.device</cite>…) – The list of devices where the data has to be
sent. The i-th sample returned by the <cite>loader</cite> will be sent to <cite>devices[i
% len(devices)]</cite>.</p></li>
<li><p><strong>batchdim</strong> (<em>python:int</em><em>, </em><em>optional</em>) – The dimension which is holding the batch size.
Default: 0</p></li>
<li><p><strong>loader_prefetch_size</strong> (<em>python:int</em><em>, </em><em>optional</em>) – The max capacity of the queue used by
the thread which is reading samples from the <cite>loader</cite>, to be processed by
the worker threads which upload data to the devices.
Default: 8</p></li>
<li><p><strong>device_prefetch_size</strong> (<em>python:int</em><em>, </em><em>optional</em>) – The max size of the per-device queues,
where the worker threads deposit tensors which have already been sent to
devices.
Default: 4</p></li>
</ul>
</dd>
</dl>
<dl class="method">
<dt id="torch_xla.distributed.parallel_loader.ParallelLoader.per_device_loader">
<code class="sig-name descname">per_device_loader</code><span class="sig-paren">(</span><em class="sig-param">device</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/distributed/parallel_loader.html#ParallelLoader.per_device_loader"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.distributed.parallel_loader.ParallelLoader.per_device_loader" title="Permalink to this definition">¶</a></dt>
<dd><p>Retrieves the loader iterator object for the given device.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>device</strong> (<cite>torch.device</cite>) – The device whole loader is being requested.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The loader iterator object for the <cite>device</cite>. This is not a
<cite>torch.utils.data.DataLoader</cite> interface, but a Python iterator which
returns the same tensor data structure as returned by the wrapped
<cite>torch.utils.data.DataLoader</cite>, but residing on XLA devices.</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<span class="target" id="module-torch_xla.distributed.xla_multiprocessing"></span><dl class="function">
<dt id="torch_xla.distributed.xla_multiprocessing.spawn">
<code class="sig-prename descclassname">torch_xla.distributed.xla_multiprocessing.</code><code class="sig-name descname">spawn</code><span class="sig-paren">(</span><em class="sig-param">fn</em>, <em class="sig-param">args=()</em>, <em class="sig-param">nprocs=None</em>, <em class="sig-param">join=True</em>, <em class="sig-param">daemon=False</em>, <em class="sig-param">start_method='spawn'</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/distributed/xla_multiprocessing.html#spawn"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.distributed.xla_multiprocessing.spawn" title="Permalink to this definition">¶</a></dt>
<dd><p>Enables multi processing based replication.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>fn</strong> (<em>callable</em>) – The function to be called for each device which takes part of
the replication. The function will be called with a first argument being
the global index of the process within the replication, followed by the
arguments passed in <cite>args</cite>.</p></li>
<li><p><strong>args</strong> (<em>tuple</em>) – The arguments for <cite>fn</cite>.
Default: Empty tuple</p></li>
<li><p><strong>nprocs</strong> (<em>python:int</em>) – The number of processes/devices for the replication. At the
moment, if specified, can be either 1 or the maximum number of devices.</p></li>
<li><p><strong>join</strong> (<em>bool</em>) – Whether the call should block waiting for the completion of the
processes which have being spawned.
Default: True</p></li>
<li><p><strong>daemon</strong> (<em>bool</em>) – Whether the processes being spawned should have the <cite>daemon</cite>
flag set (see Python multi-processing API).
Default: False</p></li>
<li><p><strong>start_method</strong> (<em>string</em>) – The Python <cite>multiprocessing</cite> process creation method.
Default: <cite>spawn</cite></p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The same object returned by the <cite>torch.multiprocessing.spawn</cite> API. If
<cite>nprocs</cite> is 1 the <cite>fn</cite> function will be called directly, and the API will
return None.</p>
</dd>
</dl>
</dd></dl>

<dl class="class">
<dt id="torch_xla.distributed.xla_multiprocessing.MpModelWrapper">
<em class="property">class </em><code class="sig-prename descclassname">torch_xla.distributed.xla_multiprocessing.</code><code class="sig-name descname">MpModelWrapper</code><span class="sig-paren">(</span><em class="sig-param">model</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/distributed/xla_multiprocessing.html#MpModelWrapper"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.distributed.xla_multiprocessing.MpModelWrapper" title="Permalink to this definition">¶</a></dt>
<dd><p>Wraps a model to minimize host memory usage when <cite>fork</cite> method is used.</p>
<p>This class should be used together with the <cite>spawn(…, start_method=’fork’)</cite>
API to minimize the use of host memory.
Instead of creating models on each multiprocessing process, hence replicating
the model’s initial host memory, the model is created once at global scope,
and then moved into each device inside the <cite>spawn()</cite> target function.
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WRAPPED_MODEL</span> <span class="o">=</span> <span class="n">xmp</span><span class="o">.</span><span class="n">MpModelWrapper</span><span class="p">(</span><span class="n">MyNetwork</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">_mp_fn</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
  <span class="n">device</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">()</span>
  <span class="n">model</span> <span class="o">=</span> <span class="n">WRAPPED_MODEL</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
  <span class="o">...</span>

<span class="n">xmp</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">_mp_fn</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">start_method</span><span class="o">=</span><span class="s1">&#39;fork&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This method has two advantages. First it uses only one copy of the memory
pages to host the original model weights, and second it serializes the move
of the wrapped model into each device, by lowering the load onto the system
memory during the process.</p>
<dl class="method">
<dt id="torch_xla.distributed.xla_multiprocessing.MpModelWrapper.to">
<code class="sig-name descname">to</code><span class="sig-paren">(</span><em class="sig-param">device</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/distributed/xla_multiprocessing.html#MpModelWrapper.to"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.distributed.xla_multiprocessing.MpModelWrapper.to" title="Permalink to this definition">¶</a></dt>
<dd><p>Retrieves the model moved onto the specified device.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>device</strong> (<em>torch.device</em>) – The device where the model should be moved onto.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The model on the specified device.</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="torch_xla.distributed.xla_multiprocessing.MpSerialExecutor">
<em class="property">class </em><code class="sig-prename descclassname">torch_xla.distributed.xla_multiprocessing.</code><code class="sig-name descname">MpSerialExecutor</code><a class="reference internal" href="_modules/torch_xla/distributed/xla_multiprocessing.html#MpSerialExecutor"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.distributed.xla_multiprocessing.MpSerialExecutor" title="Permalink to this definition">¶</a></dt>
<dd><p>Utility to run a function in a serialized fashion among multi-core processes.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># At global scope.</span>
<span class="n">SERIAL_EXEC</span> <span class="o">=</span> <span class="n">xmp</span><span class="o">.</span><span class="n">MpSerialExecutor</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">maybe_download_and_load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_mp_fn</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
  <span class="c1"># Avoid all cores downloading the same data with the serial executor.</span>
  <span class="n">dataset</span> <span class="o">=</span> <span class="n">SERIAL_EXEC</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s1">&#39;/tmp/mnist-data&#39;</span><span class="p">))</span>
  <span class="o">...</span>

<span class="n">xmp</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">_mp_fn</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<dl class="method">
<dt id="torch_xla.distributed.xla_multiprocessing.MpSerialExecutor.run">
<code class="sig-name descname">run</code><span class="sig-paren">(</span><em class="sig-param">fn</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/distributed/xla_multiprocessing.html#MpSerialExecutor.run"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.distributed.xla_multiprocessing.MpSerialExecutor.run" title="Permalink to this definition">¶</a></dt>
<dd><p>Runs the provided function serialized WRT each per-core process.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>fn</strong> (<em>callable</em>) – The function to run in a serialized fashion.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The <cite>fn</cite> return value.</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="module-torch_xla.utils.tf_record_reader">
<span id="utils"></span><h2>utils<a class="headerlink" href="#module-torch_xla.utils.tf_record_reader" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="torch_xla.utils.tf_record_reader.TfRecordReader">
<em class="property">class </em><code class="sig-prename descclassname">torch_xla.utils.tf_record_reader.</code><code class="sig-name descname">TfRecordReader</code><span class="sig-paren">(</span><em class="sig-param">path</em>, <em class="sig-param">compression=''</em>, <em class="sig-param">buffer_size=16777216</em>, <em class="sig-param">transforms=None</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/utils/tf_record_reader.html#TfRecordReader"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.utils.tf_record_reader.TfRecordReader" title="Permalink to this definition">¶</a></dt>
<dd><p>Reads TfRecords or TfExamples.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>path</strong> (<em>string</em>) – The path to the file containing TfRecords.</p></li>
<li><p><strong>compression</strong> (<em>string</em><em>, </em><em>optional</em>) – The compression type. The empty string for
no compression, otherwise <code class="docutils literal notranslate"><span class="pre">ZLIB</span></code> or <code class="docutils literal notranslate"><span class="pre">GZIP</span></code>.
Default: No compression.</p></li>
<li><p><strong>buffer_size</strong> (<em>python:int</em><em>, </em><em>optional</em>) – The size of the buffer to be used to read
TfRecords.
Default: 16 * 1024 * 1024</p></li>
<li><p><strong>transforms</strong> (<em>dict</em><em>, </em><em>optional</em>) – A dictionary with the key matching the
TfExample label name, and value which is either a callable which will be
called to tranform the matching tensor data, or <code class="docutils literal notranslate"><span class="pre">STR</span></code> for string
conversion.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<span class="target" id="module-torch_xla.utils.utils"></span><dl class="class">
<dt id="torch_xla.utils.utils.SampleGenerator">
<em class="property">class </em><code class="sig-prename descclassname">torch_xla.utils.utils.</code><code class="sig-name descname">SampleGenerator</code><span class="sig-paren">(</span><em class="sig-param">data</em>, <em class="sig-param">sample_count</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/utils/utils.html#SampleGenerator"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.utils.utils.SampleGenerator" title="Permalink to this definition">¶</a></dt>
<dd><p>Iterator which returns multiple samples of a given input data.</p>
<p>Can be used in place of a PyTorch <cite>DataLoader</cite> to generate synthetic data.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data</strong> – The data which should be returned at each iterator step.</p></li>
<li><p><strong>sample_count</strong> – The maximum number of <cite>data</cite> samples to be returned.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="class">
<dt id="torch_xla.utils.utils.DataWrapper">
<em class="property">class </em><code class="sig-prename descclassname">torch_xla.utils.utils.</code><code class="sig-name descname">DataWrapper</code><a class="reference internal" href="_modules/torch_xla/utils/utils.html#DataWrapper"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.utils.utils.DataWrapper" title="Permalink to this definition">¶</a></dt>
<dd><p>Utility class to wrap data structures to be sent to device.</p>
</dd></dl>

<span class="target" id="module-torch_xla.utils.serialization"></span><dl class="function">
<dt id="torch_xla.utils.serialization.save">
<code class="sig-prename descclassname">torch_xla.utils.serialization.</code><code class="sig-name descname">save</code><span class="sig-paren">(</span><em class="sig-param">data</em>, <em class="sig-param">path</em>, <em class="sig-param">master_only=True</em>, <em class="sig-param">global_master=False</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/utils/serialization.html#save"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.utils.serialization.save" title="Permalink to this definition">¶</a></dt>
<dd><p>Saves the input data into a file.</p>
<p>The saved data is transferred to PyTorch CPU device before being saved, so a
following <cite>torch.load()</cite> will load CPU data.
Care must be taken when working with views. Instead of saving views it’s
recommended that you recreate them after the tensors have been loaded and
moved to their destination device(s).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data</strong> – The input data to be saved. Any nested combination of Python objects
(list, tuples, sets, dicts, …).</p></li>
<li><p><strong>path</strong> – The destination file for the data saving operation. If <cite>master_only</cite>
is <code class="docutils literal notranslate"><span class="pre">False</span></code> the path must point to different destinations as otherwise
all the writes from the same host will override each other.</p></li>
<li><p><strong>master_only</strong> (<em>bool</em><em>, </em><em>optional</em>) – Whether only the master device should save the
data. If False, the <cite>path</cite> argument should be a different path for each of
the ordinals taking part to the replication, otherwise all the replicas on
the same host will be writing to the same location.
Default: True</p></li>
<li><p><strong>global_master</strong> (<em>bool</em><em>, </em><em>optional</em>) – When <code class="docutils literal notranslate"><span class="pre">master_only</span></code> is <code class="docutils literal notranslate"><span class="pre">True</span></code> this flag
controls whether every host’s master (if <code class="docutils literal notranslate"><span class="pre">global_master</span></code> is <code class="docutils literal notranslate"><span class="pre">False</span></code>)
saves the content, or only the global master (ordinal 0).
Default: False</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.utils.serialization.load">
<code class="sig-prename descclassname">torch_xla.utils.serialization.</code><code class="sig-name descname">load</code><span class="sig-paren">(</span><em class="sig-param">path</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/utils/serialization.html#load"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.utils.serialization.load" title="Permalink to this definition">¶</a></dt>
<dd><p>Loads data previously saved with the <cite>save()</cite> API.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>path</strong> (<em>str</em>) – The path passed to the <cite>save()</cite> API.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The loaded data.</p>
</dd>
</dl>
</dd></dl>

<span class="target" id="module-torch_xla.utils.gcsfs"></span><dl class="function">
<dt id="torch_xla.utils.gcsfs.open">
<code class="sig-prename descclassname">torch_xla.utils.gcsfs.</code><code class="sig-name descname">open</code><span class="sig-paren">(</span><em class="sig-param">path</em>, <em class="sig-param">mode='r'</em>, <em class="sig-param">encoding=None</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/utils/gcsfs.html#open"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.utils.gcsfs.open" title="Permalink to this definition">¶</a></dt>
<dd><p>Opens a Google Cloud Storage (GCS) file for reading or writing.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>path</strong> (<em>string</em>) – The GCS path of the file. Must be “gs://BUCKET_NAME/PATH”
where <code class="docutils literal notranslate"><span class="pre">BUCKET_NAME</span></code> is the name of the GCS bucket, and <code class="docutils literal notranslate"><span class="pre">PATH</span></code> is a <cite>/</cite>
delimited path.</p></li>
<li><p><strong>mode</strong> (<em>string</em><em>, </em><em>optional</em>) – The open mode, similar to the <code class="docutils literal notranslate"><span class="pre">open()</span></code> API.
Default: ‘r’</p></li>
<li><p><strong>encoding</strong> (<em>string</em><em>, </em><em>optional</em>) – The character encoding to be used to decode
bytes into strings when opening in text mode.
Default: None</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The GCS file object.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.utils.gcsfs.list">
<code class="sig-prename descclassname">torch_xla.utils.gcsfs.</code><code class="sig-name descname">list</code><span class="sig-paren">(</span><em class="sig-param">path</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/utils/gcsfs.html#list"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.utils.gcsfs.list" title="Permalink to this definition">¶</a></dt>
<dd><p>Lists the content of a GCS bucket.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>path</strong> (<em>string</em>) – The GCS path of the file. Must be “gs://BUCKET_NAME/PATH”
where <code class="docutils literal notranslate"><span class="pre">BUCKET_NAME</span></code> is the name of the GCS bucket, and <code class="docutils literal notranslate"><span class="pre">PATH</span></code> is a <cite>/</cite>
delimited path.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A list of <code class="docutils literal notranslate"><span class="pre">GcsBlob</span></code> objects.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.utils.gcsfs.stat">
<code class="sig-prename descclassname">torch_xla.utils.gcsfs.</code><code class="sig-name descname">stat</code><span class="sig-paren">(</span><em class="sig-param">path</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/utils/gcsfs.html#stat"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.utils.gcsfs.stat" title="Permalink to this definition">¶</a></dt>
<dd><p>Fetches the information of a GCS file.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>path</strong> (<em>string</em>) – The GCS path of the file. Must be “gs://BUCKET_NAME/PATH”
where <code class="docutils literal notranslate"><span class="pre">BUCKET_NAME</span></code> is the name of the GCS bucket, and <code class="docutils literal notranslate"><span class="pre">PATH</span></code> is a <cite>/</cite>
delimited path.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A <code class="docutils literal notranslate"><span class="pre">GcsBlob</span></code> object.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.utils.gcsfs.remove">
<code class="sig-prename descclassname">torch_xla.utils.gcsfs.</code><code class="sig-name descname">remove</code><span class="sig-paren">(</span><em class="sig-param">path</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/utils/gcsfs.html#remove"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.utils.gcsfs.remove" title="Permalink to this definition">¶</a></dt>
<dd><p>Removes a GCS blob.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>path</strong> (<em>string</em>) – The GCS path of the file. Must be “gs://BUCKET_NAME/PATH”
where <code class="docutils literal notranslate"><span class="pre">BUCKET_NAME</span></code> is the name of the GCS bucket, and <code class="docutils literal notranslate"><span class="pre">PATH</span></code> is a <cite>/</cite>
delimited path.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.utils.gcsfs.rmtree">
<code class="sig-prename descclassname">torch_xla.utils.gcsfs.</code><code class="sig-name descname">rmtree</code><span class="sig-paren">(</span><em class="sig-param">path</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/utils/gcsfs.html#rmtree"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.utils.gcsfs.rmtree" title="Permalink to this definition">¶</a></dt>
<dd><p>Removes all the GCS blobs within a given path.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>path</strong> (<em>string</em>) – <p>The GCS path of the file pattern or folder. Must be
“gs://BUCKET_NAME/PATH” where <code class="docutils literal notranslate"><span class="pre">BUCKET_NAME</span></code> is the name of the GCS</p>
<blockquote>
<div><p>bucket, and <code class="docutils literal notranslate"><span class="pre">PATH</span></code> is a <cite>/</cite> delimited path.</p>
</div></blockquote>
</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.utils.gcsfs.read">
<code class="sig-prename descclassname">torch_xla.utils.gcsfs.</code><code class="sig-name descname">read</code><span class="sig-paren">(</span><em class="sig-param">path</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/utils/gcsfs.html#read"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.utils.gcsfs.read" title="Permalink to this definition">¶</a></dt>
<dd><p>Reads the whole content of a GCS blob.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>path</strong> (<em>string</em>) – The GCS path of the file. Must be “gs://BUCKET_NAME/PATH”
where <code class="docutils literal notranslate"><span class="pre">BUCKET_NAME</span></code> is the name of the GCS bucket, and <code class="docutils literal notranslate"><span class="pre">PATH</span></code> is a <cite>/</cite>
delimited path.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The bytes stored within the GCS blob.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.utils.gcsfs.write">
<code class="sig-prename descclassname">torch_xla.utils.gcsfs.</code><code class="sig-name descname">write</code><span class="sig-paren">(</span><em class="sig-param">path</em>, <em class="sig-param">content</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/utils/gcsfs.html#write"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.utils.gcsfs.write" title="Permalink to this definition">¶</a></dt>
<dd><p>Write a string/bytes or file into a GCS blob.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>path</strong> (<em>string</em>) – The GCS path of the file. Must be “gs://BUCKET_NAME/PATH”
where <code class="docutils literal notranslate"><span class="pre">BUCKET_NAME</span></code> is the name of the GCS bucket, and <code class="docutils literal notranslate"><span class="pre">PATH</span></code> is a <cite>/</cite>
delimited path.</p></li>
<li><p><strong>content</strong> (<em>string</em><em>, </em><em>bytes</em><em> or </em><em>file object</em>) – The content to be written into
<code class="docutils literal notranslate"><span class="pre">path</span></code>.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.utils.gcsfs.generic_open">
<code class="sig-prename descclassname">torch_xla.utils.gcsfs.</code><code class="sig-name descname">generic_open</code><span class="sig-paren">(</span><em class="sig-param">path</em>, <em class="sig-param">mode='r'</em>, <em class="sig-param">encoding=None</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/utils/gcsfs.html#generic_open"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.utils.gcsfs.generic_open" title="Permalink to this definition">¶</a></dt>
<dd><p>Opens a file (GCS or not) for reding or writing.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>path</strong> (<em>string</em>) – <p>The path of the file to be opened. If a GCS path, it must be
“gs://BUCKET_NAME/PATH” where <code class="docutils literal notranslate"><span class="pre">BUCKET_NAME</span></code> is the name of the GCS</p>
<blockquote>
<div><p>bucket, and <code class="docutils literal notranslate"><span class="pre">PATH</span></code> is a <cite>/</cite> delimited path.</p>
</div></blockquote>
</p></li>
<li><p><strong>mode</strong> (<em>string</em><em>, </em><em>optional</em>) – The open mode, similar to the <code class="docutils literal notranslate"><span class="pre">open()</span></code> API.
Default: ‘r’</p></li>
<li><p><strong>encoding</strong> (<em>string</em><em>, </em><em>optional</em>) – The character encoding to be used to decode
bytes into strings when opening in text mode.
Default: None</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The opened file object.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.utils.gcsfs.generic_read">
<code class="sig-prename descclassname">torch_xla.utils.gcsfs.</code><code class="sig-name descname">generic_read</code><span class="sig-paren">(</span><em class="sig-param">path</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/utils/gcsfs.html#generic_read"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.utils.gcsfs.generic_read" title="Permalink to this definition">¶</a></dt>
<dd><p>Reads the whole content of the provided location.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>path</strong> (<em>string</em>) – The GCS path or local path to be read.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The bytes stored within the GCS blob or local file.</p>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.utils.gcsfs.generic_write">
<code class="sig-prename descclassname">torch_xla.utils.gcsfs.</code><code class="sig-name descname">generic_write</code><span class="sig-paren">(</span><em class="sig-param">output_string</em>, <em class="sig-param">path</em>, <em class="sig-param">makedirs=False</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/utils/gcsfs.html#generic_write"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.utils.gcsfs.generic_write" title="Permalink to this definition">¶</a></dt>
<dd><p>Write a string/bytes or file into a GCS blob or local disk.</p>
<p>Depending on the path passed in, this API can write to local or GCS file.
Checks if the <cite>path</cite> starts with the ‘gs://’ prefix, and uses <cite>open</cite> otherwise.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>output_string</strong> (<em>string</em>) – The string to be written to the output.</p></li>
<li><p><strong>path</strong> (<em>string</em>) – The GCS path or local path of the output.</p></li>
<li><p><strong>makedirs</strong> (<em>bool</em>) – Whether the <cite>path</cite> parent folders should be created if
missing.
Default: False</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="torch_xla.utils.gcsfs.is_gcs_path">
<code class="sig-prename descclassname">torch_xla.utils.gcsfs.</code><code class="sig-name descname">is_gcs_path</code><span class="sig-paren">(</span><em class="sig-param">path</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/utils/gcsfs.html#is_gcs_path"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.utils.gcsfs.is_gcs_path" title="Permalink to this definition">¶</a></dt>
<dd><p>Checks whether a path is a GCS path.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>path</strong> (<em>string</em>) – The path to be checked.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>Whether <cite>path</cite> is a GCS path.</p>
</dd>
</dl>
</dd></dl>

<span class="target" id="module-torch_xla.utils.cached_dataset"></span><dl class="class">
<dt id="torch_xla.utils.cached_dataset.CachedDataset">
<em class="property">class </em><code class="sig-prename descclassname">torch_xla.utils.cached_dataset.</code><code class="sig-name descname">CachedDataset</code><span class="sig-paren">(</span><em class="sig-param">data_set</em>, <em class="sig-param">path</em>, <em class="sig-param">max_files_per_folder=1000</em>, <em class="sig-param">compress=True</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/torch_xla/utils/cached_dataset.html#CachedDataset"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#torch_xla.utils.cached_dataset.CachedDataset" title="Permalink to this definition">¶</a></dt>
<dd><p>Wraps an existing <cite>torch.utils.data.Dataset</cite> by providing file caching.</p>
<p>The <cite>CachedDataset</cite> can be used to trade the CPU/RAM resources required to
process a raw dataset, with storage/network resources.
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span>
    <span class="n">FLAGS</span><span class="o">.</span><span class="n">datadir</span><span class="p">,</span>
    <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
        <span class="p">[</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
         <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.1307</span><span class="p">,),</span> <span class="p">(</span><span class="mf">0.3081</span><span class="p">,))]))</span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">CachedDataset</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">dscache_dir</span><span class="p">)</span>
</pre></div>
</div>
<p>The <cite>CachedDataset</cite> will transparently cache the original <cite>Dataset</cite> samples,
so that every run after the first, will not trigger any more CPU/RAM usage
related to the raw samples processing.
Once a <cite>CachedDataset</cite> is fully cached, it can be exported (ie, tar.gz) and
used in different machines.
Just unpack the tar.gz and pass <cite>None</cite> as original <cite>Dataset</cite>:
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">CachedDataset</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">FLAGS</span><span class="o">.</span><span class="n">dscache_dir</span><span class="p">)</span>
</pre></div>
</div>
<p>To fully cache <cite>CachedDataset</cite> just run the <cite>warmup()</cite> API.
A <cite>CachedDataset</cite> saved on GCS has the advantage to be able to be used from
different machines without explicit exporting.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_set</strong> (<em>torch.utils.data.Dataset</em>) – The raw <cite>torch.utils.data.Dataset</cite> to be
cached. It can be set to <cite>None</cite> in case all the input samples are stored
within the <cite>path</cite> folder.</p></li>
<li><p><strong>path</strong> (<em>string</em>) – The path where the dataset samples should be stored/loaded.
The <cite>path</cite> needs to be writeable, unless all the samples are already stored.
The <cite>path</cite> can be a GCS path (prefixed with <cite>gs://</cite>).</p></li>
<li><p><strong>max_files_per_folder</strong> (<em>python:int</em>) – The maximum amount of files to be stored within a
single folder. If <cite>data_set</cite> is <cite>None</cite> this value is ignored and taken from
the cached metadata.
Default: 1000</p></li>
<li><p><strong>compress</strong> (<em>bool</em>) – Whether the saved samples should be compressed. Compression
saves space at the expense of CPU required to compress/decompress.
If <cite>data_set</cite> is <cite>None</cite> this value is ignored and taken from the cached
metadata.
Default: True</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="test">
<h2>test<a class="headerlink" href="#test" title="Permalink to this headline">¶</a></h2>
</div>
</div>
<div class="section" id="troubleshooting">
<h1>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h1>
<p>Note that the information in this section is subject to be removed in future releases of the <em>PyTorch/XLA</em> software,
since many of them are peculiar to a given internal implementation which might change.</p>
<p>To diagnose issues, we can use the execution metrics and counters provided by <em>PyTorch/XLA</em>
The <strong>first thing</strong> to check when model is slow is to generate a metrics report.</p>
<p>Metrics report is extremely helpful in diagnosing issues. Please try to include it in your bug
report sent to us if you have it.</p>
<div class="section" id="perform-a-auto-metrics-analysis">
<h2>Perform A Auto-Metrics Analysis<a class="headerlink" href="#perform-a-auto-metrics-analysis" title="Permalink to this headline">¶</a></h2>
<p>We provide ways to automatically analyze the metrics report and provide a summary. Simply run your workload with <code class="docutils literal notranslate"><span class="pre">PT_XLA_DEBUG=1</span></code>. Some example output would be</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pt</span><span class="o">-</span><span class="n">xla</span><span class="o">-</span><span class="n">profiler</span><span class="p">:</span> <span class="n">CompileTime</span> <span class="n">too</span> <span class="n">frequent</span><span class="p">:</span> <span class="mi">21</span> <span class="n">counts</span> <span class="n">during</span> <span class="mi">11</span> <span class="n">steps</span>
<span class="n">pt</span><span class="o">-</span><span class="n">xla</span><span class="o">-</span><span class="n">profiler</span><span class="p">:</span> <span class="n">TransferFromServerTime</span> <span class="n">too</span> <span class="n">frequent</span><span class="p">:</span> <span class="mi">11</span> <span class="n">counts</span> <span class="n">during</span> <span class="mi">11</span> <span class="n">steps</span>
<span class="n">pt</span><span class="o">-</span><span class="n">xla</span><span class="o">-</span><span class="n">profiler</span><span class="p">:</span> <span class="n">Op</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">not</span> <span class="n">lowered</span><span class="p">:</span> <span class="n">aten</span><span class="p">::</span><span class="n">_ctc_loss</span><span class="p">,</span> <span class="n">aten</span><span class="p">::</span><span class="n">_ctc_loss_backward</span><span class="p">,</span>  <span class="n">Please</span> <span class="nb">open</span> <span class="n">a</span> <span class="n">GitHub</span> <span class="n">issue</span> <span class="k">with</span> <span class="n">the</span> <span class="n">above</span> <span class="n">op</span> <span class="n">lowering</span> <span class="n">requests</span><span class="o">.</span>
<span class="n">pt</span><span class="o">-</span><span class="n">xla</span><span class="o">-</span><span class="n">profiler</span><span class="p">:</span> <span class="n">CompileTime</span> <span class="n">too</span> <span class="n">frequent</span><span class="p">:</span> <span class="mi">23</span> <span class="n">counts</span> <span class="n">during</span> <span class="mi">12</span> <span class="n">steps</span>
<span class="n">pt</span><span class="o">-</span><span class="n">xla</span><span class="o">-</span><span class="n">profiler</span><span class="p">:</span> <span class="n">TransferFromServerTime</span> <span class="n">too</span> <span class="n">frequent</span><span class="p">:</span> <span class="mi">12</span> <span class="n">counts</span> <span class="n">during</span> <span class="mi">12</span> <span class="n">steps</span>
</pre></div>
</div>
<p>Following section will explain how to get and understand a more detial metrics report.</p>
</div>
<div class="section" id="get-a-metrics-report">
<h2>Get A Metrics Report<a class="headerlink" href="#get-a-metrics-report" title="Permalink to this headline">¶</a></h2>
<p>Put the following line in your program to generate a report:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch_xla.debug.metrics</span> <span class="k">as</span> <span class="nn">met</span>

<span class="nb">print</span><span class="p">(</span><span class="n">met</span><span class="o">.</span><span class="n">metrics_report</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="section" id="understand-the-metrics-report">
<h2>Understand The Metrics Report<a class="headerlink" href="#understand-the-metrics-report" title="Permalink to this headline">¶</a></h2>
<p>The report includes things like:</p>
<ul class="simple">
<li><p>how many time we issue <em>XLA</em> compilations and time spent on issuing.</p></li>
<li><p>how many times we execute and time spent on execution</p></li>
<li><p>how many device data handles we create/destroy etc.</p></li>
</ul>
<p>This information is reported in terms of percentiles of the samples. An example is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Metric</span><span class="p">:</span> <span class="n">CompileTime</span>
  <span class="n">TotalSamples</span><span class="p">:</span> <span class="mi">202</span>
  <span class="n">Counter</span><span class="p">:</span> <span class="mi">06</span><span class="n">m09s401ms746</span><span class="o">.</span><span class="mi">001</span><span class="n">us</span>
  <span class="n">ValueRate</span><span class="p">:</span> <span class="mi">778</span><span class="n">ms572</span><span class="o">.</span><span class="mi">062</span><span class="n">us</span> <span class="o">/</span> <span class="n">second</span>
  <span class="n">Rate</span><span class="p">:</span> <span class="mf">0.425201</span> <span class="o">/</span> <span class="n">second</span>
  <span class="n">Percentiles</span><span class="p">:</span> <span class="mi">1</span><span class="o">%=</span><span class="mi">001</span><span class="n">ms32</span><span class="o">.</span><span class="mi">778</span><span class="n">us</span><span class="p">;</span> <span class="mi">5</span><span class="o">%=</span><span class="mi">001</span><span class="n">ms61</span><span class="o">.</span><span class="mi">283</span><span class="n">us</span><span class="p">;</span> <span class="mi">10</span><span class="o">%=</span><span class="mi">001</span><span class="n">ms79</span><span class="o">.</span><span class="mi">236</span><span class="n">us</span><span class="p">;</span> <span class="mi">20</span><span class="o">%=</span><span class="mi">001</span><span class="n">ms110</span><span class="o">.</span><span class="mi">973</span><span class="n">us</span><span class="p">;</span> <span class="mi">50</span><span class="o">%=</span><span class="mi">001</span><span class="n">ms228</span><span class="o">.</span><span class="mi">773</span><span class="n">us</span><span class="p">;</span> <span class="mi">80</span><span class="o">%=</span><span class="mi">001</span><span class="n">ms339</span><span class="o">.</span><span class="mi">183</span><span class="n">us</span><span class="p">;</span> <span class="mi">90</span><span class="o">%=</span><span class="mi">001</span><span class="n">ms434</span><span class="o">.</span><span class="mi">305</span><span class="n">us</span><span class="p">;</span> <span class="mi">95</span><span class="o">%=</span><span class="mi">002</span><span class="n">ms921</span><span class="o">.</span><span class="mi">063</span><span class="n">us</span><span class="p">;</span> <span class="mi">99</span><span class="o">%=</span><span class="mi">21</span><span class="n">s102ms853</span><span class="o">.</span><span class="mi">173</span><span class="n">us</span>
</pre></div>
</div>
<p>We also provide counters, which are named integer variables which track internal software status. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Counter</span><span class="p">:</span> <span class="n">CachedSyncTensors</span>
  <span class="n">Value</span><span class="p">:</span> <span class="mi">395</span>
</pre></div>
</div>
<p>In this report, any counter that starts with <code class="docutils literal notranslate"><span class="pre">aten::</span></code>
indicates a context switch between the XLA device and CPU, which can be a
potential performance optimization area in the model code.</p>
<p>Counters are useful to understand which operations are routed back to the CPU engine of <em>PyTorch</em>.
They are fully qualified with their C++ namespace:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Counter</span><span class="p">:</span> <span class="n">aten</span><span class="p">::</span><span class="n">nonzero</span>
  <span class="n">Value</span><span class="p">:</span> <span class="mi">33</span>
</pre></div>
</div>
<p>If you see <code class="docutils literal notranslate"><span class="pre">aten::</span></code> ops other than <code class="docutils literal notranslate"><span class="pre">nonzero</span></code> and <code class="docutils literal notranslate"><span class="pre">_local_scalar_dense</span></code>, that usually means a missing
lowering in PyTorch/XLA. Feel free to open a feature request for it on <a class="reference external" href="https://github.com/pytorch/xla/issues">GitHub issues</a>.</p>
</div>
<div class="section" id="performance-profiling">
<h2>Performance Profiling<a class="headerlink" href="#performance-profiling" title="Permalink to this headline">¶</a></h2>
<p>To profile your workload in depth to undertand bottlenecks please check the following resources:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://cloud.google.com/tpu/docs/pytorch-xla-performance-profiling-tpu-vm">Official tutorial</a></p></li>
<li><p><a class="reference external" href="https://colab.research.google.com/github/pytorch/xla/blob/master/contrib/colab/pytorch-xla-profiling-colab.ipynb">Colab notebook</a></p></li>
<li><p><a class="reference external" href="https://github.com/pytorch/xla/blob/master/test/test_profile_mp_mnist.py">Sample MNIST training script with profiling</a></p></li>
<li><p><a class="reference external" href="https://github.com/pytorch/xla/blob/master/scripts/capture_profile.py">Utility script for capturing performance profiles</a></p></li>
</ul>
</div>
<div class="section" id="known-performance-caveats">
<h2>Known Performance Caveats<a class="headerlink" href="#known-performance-caveats" title="Permalink to this headline">¶</a></h2>
<p>PyTorch/XLA behaves semantically like regular PyTorch and XLA tensors share the full tensor interface with CPU &amp; GPU tensors.
However, constraints in XLA/hardware and the lazy evaluation model suggest certain patterns might result in bad performance.</p>
<p>If your model shows bad performance, keep in mind the following caveats:</p>
<ol class="arabic">
<li><p><strong>XLA/TPU yield degraded performance with too many recompilations.</strong></p>
<p>XLA compilation is expensive. PyTorch/XLA automatically recompiles the graph every time new shapes are encountered.
Usually models should stabilize within a few steps and you can see huge speedup for the rest of training.</p>
<p>In order to avoid recompilations, not only must shapes be constant, but computations across XLA devices in all hosts should also be constant.</p>
<p><em>Possible sources</em>:</p>
<ul class="simple">
<li><p>Direct or indirect uses of <code class="docutils literal notranslate"><span class="pre">nonzero</span></code> introduce dynamic shapes; for example, masked indexing <code class="docutils literal notranslate"><span class="pre">base[index]</span></code> where <code class="docutils literal notranslate"><span class="pre">index</span></code> is a mask tensor.</p></li>
<li><p>Loops with a different number of iterations between steps can result in different execution graphs, thus require recompilations.</p></li>
</ul>
<p><em>Solution</em>:</p>
<ul class="simple">
<li><p>Tensor shapes should be the same between iterations, or a low number of shape variations should be used.</p></li>
<li><p>Pad tensors to fixed sizes when possible.</p></li>
</ul>
</li>
<li><p><strong>Certain operations don’t have native translations to XLA.</strong></p>
<p>For these operations PyTorch/XLA automatically transfers to the CPU memory, evaluates on CPU, and transfers the result back to the XLA device.
Doing too many such operations during the training step can lead to significant slowdowns.</p>
<p><em>Possible sources</em>:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">item()</span></code> operation explicitly asks to evaluate the result. Don’t use it unless it’s necessary.</p></li>
</ul>
<p><em>Solution</em>:</p>
<ul>
<li><p>For most ops we can lower them to XLA to fix it. Checkout <a class="reference external" href="#metrics-report">metrics report section</a> to find out the missing ops and open a feature request on <a class="reference external" href="https://github.com/pytorch/xla/issues">GitHub</a>.</p></li>
<li><p>Even when a PyTorch tensor is known as a scalar, avoid using <code class="docutils literal notranslate"><span class="pre">tensor.item()</span></code>. Keep it as a tensor and use tensor operations on it.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">torch.where</span></code> to substitute control flow when applicable.
E.g. The control flow with <code class="docutils literal notranslate"><span class="pre">item()</span></code> used in <a class="reference external" href="https://github.com/pytorch/pytorch/blob/de19eeee99a2a282fc441f637b23d8e50c75ecd1/torch/nn/utils/clip_grad.py#L33">clip_grad*norm*</a> is problematic and impacts performance, so we have <a class="reference external" href="https://github.com/pytorch/xla/blob/master/torch_patches/X10-clip_grad.diff">patched</a> <code class="docutils literal notranslate"><span class="pre">clip_grad_norm_</span></code> by calling <code class="docutils literal notranslate"><span class="pre">torch.where</span></code> instead, which gives us a dramatic performance improvement.
.. code-block:: python</p>
<blockquote>
<div><p>…
else:</p>
<blockquote>
<div><p>device = parameters[0].device
total_norm = torch.zeros([], device=device if parameters else None)
for p in parameters:</p>
<blockquote>
<div><p>param_norm = p.grad.data.norm(norm_type) ** norm_type
total_norm.add_(param_norm)</p>
</div></blockquote>
<p>total_norm = (total_norm ** (1. / norm_type))</p>
</div></blockquote>
<p>clip_coef = torch.tensor(max_norm, device=device) / (total_norm + 1e-6)
for p in parameters:</p>
<blockquote>
<div><p>p.grad.data.mul_(torch.where(clip_coef &lt; 1, clip_coef, torch.tensor(1., device=device)))</p>
</div></blockquote>
</div></blockquote>
</li>
</ul>
</li>
<li><p><strong>Iterators in ``torch_xla.distributed.data_parallel`` may drop the last few batches in the input iterator.</strong></p>
<p>This is to make sure we do the same amount of work on all XLA devices.</p>
<p><em>Solution</em>:</p>
<ul class="simple">
<li><p>When dataset is small, and there are too few steps, this may result in a no-op epoch. Therefore, it is better to use
small batch sizes in those cases.</p></li>
</ul>
</li>
</ol>
</div>
<div class="section" id="xla-tensor-quirks">
<h2>XLA Tensor Quirks<a class="headerlink" href="#xla-tensor-quirks" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p><strong>XLA tensor internals are opaque.</strong> XLA tensors always appear to be
contiguous and without storage. Networks should not try to check the strides
of XLA tensors.</p></li>
<li><p><strong>XLA tensors should be moved to the CPU before saving them.</strong> Saving
XLA tensors directly causes them to be loaded back on the device(s) they were
saved from. If a device is unavailable at load time then the load will fail.
Moving XLA tensors to the CPU before saving them lets you decide which
device(s) to put the loaded tensors on. This is necessary if you want to
load the tensors on a machine without XLA devices. Care should be taken
moving the XLA tensors to the CPU before saving them, however, as moving
tensors across device types does not preserve view relationships. Instead,
views should be reconstructed as necessary after the tensors are loaded.</p></li>
<li><p><strong>Copying an XLA Tensor with Python’s copy.copy returns a deep copy, not a
shallow copy.</strong> Use a view of an XLA tensor to get a shallow copy of it.</p></li>
<li><p><strong>Handling shared weights.</strong> Modules can share weights by setting the
Parameters of one module to another. This “tying” of module weights should
be done <strong>AFTER</strong> the modules are moved to an XLA device. Otherwise two
independent copies of the shared tensor will be made on the XLA device.</p></li>
</ol>
</div>
<div class="section" id="more-debugging-tools">
<h2>More Debugging Tools<a class="headerlink" href="#more-debugging-tools" title="Permalink to this headline">¶</a></h2>
<p>We don’t expect users to use tools in this section to debug their models. But we might ask for
them when you submit a bug report since they provide additional information that metrics report
doesn’t have.</p>
<div class="section" id="environment-variables">
<h3>Environment Variables<a class="headerlink" href="#environment-variables" title="Permalink to this headline">¶</a></h3>
<p>There are also a number of environment variables which control the behavior of the <em>PyTorch/XLA</em>
software stack.</p>
<p>Setting such variables will cause different degrees of performance degradation, so they should
only be enabled for debugging.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">XLA_IR_DEBUG</span></code>: Enables the <em>Python</em> stack trace to be captured where creating IR nodes,
hence allowing to understand which <em>PyTorch</em> operation was responsible for generating the IR.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">XLA_HLO_DEBUG</span></code>: Enables the <em>Python</em> stack frame captured when _XLA_IR<em>DEBUG</em> is active,
to be propagated to the <em>XLA</em> <em>HLO</em> metadata.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">XLA_SAVE_TENSORS_FILE</span></code>: The path to a file which will be used to dump the IR graphs during
execution. Note that the file can become really big if the option is left enabled and the
<em>PyTorch</em> program let run for long time. The graphs are appended to the file, so to have a clean
sheet from run to run, the file should be explicitly removed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">XLA_SAVE_TENSORS_FMT</span></code>: The format of the graphs stored within the _XLA_SAVE_TENSORS<em>FILE</em>
file. Can be <code class="docutils literal notranslate"><span class="pre">text</span></code> (the default), <code class="docutils literal notranslate"><span class="pre">dot</span></code> (the <em>Graphviz</em> format) or <code class="docutils literal notranslate"><span class="pre">hlo</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">XLA_METRICS_FILE</span></code>: If set, the path to a local file where the internal metrics will be
saved at every step. Metrics will be appended to the file, if already existing.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">XLA_SAVE_HLO_FILE</span></code>: If set, the path to a local file where, in case of compilation/execution
error, the offending HLO graph will be saved.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">XLA_GET_TENSORS_OPBYOP</span></code>: Enables pure <em>OpByOp</em> dispatch. The <em>PyTorch/XLA</em> software tries to
fuse together many <em>PyTorch</em> operations into a single computation graph, but sometimes, either
for debugging, or in case the <em>PyTorch</em> code have a very dynamic nature (in shapes or graph
terms), it is better to force the execution in <em>OpByOp</em> mode (every IR node is lowered into
a separate <em>XLA</em> computation, and chain-executed). This environment variable, if set to 1,
enables <em>OpByOp</em> during the “get tensors” operation (the operation used by <em>PyTorch/XLA</em> to
fetch intermediate values back from the <em>TPU</em> device into <em>PyTorch</em> CPU tensors).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">XLA_SYNC_TENSORS_OPBYOP</span></code>: The same as _XLA_GET_TENSORS<em>OPBYOP</em> but for “sync tensors”
operation (the operation used at the end of a step, to flush pending IR computations and
materialize them into <em>TPU</em> device data).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">XLA_SYNC_WAIT</span></code>: Forces the XLA tensor sync operation to wait for its completion, before
moving to the next step.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">XLA_USE_BF16</span></code>: If set to 1, tranforms all the <em>PyTorch</em> <em>Float</em> values into <em>BiFloat16</em>
when sending to the <em>TPU</em> device. Note that when using <code class="docutils literal notranslate"><span class="pre">XLA_USE_BF16=1</span></code> tensor arithmetic will
be done in reduced precision and so tensors will not be accurate if accumulated over time.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># In reduced bfloat16 precision</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">)</span>
<span class="n">tensor</span><span class="p">(</span><span class="mf">4096.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">)</span>
<span class="c1"># Whereas in full float32 precision</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">tensor</span><span class="p">(</span><span class="mi">4097</span><span class="p">)</span>
</pre></div>
</div>
<p>So to get accurate metrics such as average loss value over many steps, use manual mixed
precision where metrics stay in FP32.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">XLA_USE_F16</span></code>: If set to 1, tranforms all the <em>PyTorch</em> <em>Float</em> values into <em>Float16</em>
(<em>PyTorch</em> <em>Half</em> type) when sending to devices which supports them.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">XLA_USE_32BIT_LONG</span></code>: If set to 1, maps <em>PyTorch</em> <em>Long</em> types to <em>XLA</em> 32bit type.
On the versions of the TPU HW at the time of writing, 64bit integer computations are
expensive, so setting this flag might help. It should be verified by the user that truncating
to 32bit values is a valid operation according to the use of <em>PyTorch</em> <em>Long</em> values in it.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TF_CPP_LOG_THREAD_ID</span></code>: If set to 1, the TF logs will show the thread ID
helping with debugging multithreaded processes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TF_CPP_VMODULE</span></code>: Environment variable used for TF VLOGs and takes the
form of <code class="docutils literal notranslate"><span class="pre">TF_CPP_VMODULE=name=value,...</span></code>. Note that for VLOGs you must set
<code class="docutils literal notranslate"><span class="pre">TF_CPP_MIN_LOG_LEVEL=0</span></code>. For PyTorch/XLA using a configuration like
<code class="docutils literal notranslate"><span class="pre">TF_CPP_VMODULE=tensor=5</span></code> would enable logging such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>2019-10-03 17:23:56.419040: I   27891 torch_xla/csrc/tensor.cpp:1104]
Executing IR graph hash 4211381954965020633 on device TPU:3 done!
2019-10-03 17:23:56.419448: I   27890 torch_xla/csrc/tensor.cpp:1104]
Executing IR graph hash 15483856951158150605 on device TPU:5 done!
2019-10-03 17:23:56.419539: I   27896 torch_xla/csrc/tensor.cpp:1104]
Executing IR graph hash 4211381954965020633 on device TPU:4 done!
...
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">TF_CPP_MIN_LOG_LEVEL</span></code>: Level to print messages for. <code class="docutils literal notranslate"><span class="pre">TF_CPP_MIN_LOG_LEVEL=0</span></code> will turn
on INFO logging, <code class="docutils literal notranslate"><span class="pre">TF_CPP_MIN_LOG_LEVEL=1</span></code> WARNING and so on. Our PyTorch/XLA <code class="docutils literal notranslate"><span class="pre">TF_VLOG</span></code> uses
<code class="docutils literal notranslate"><span class="pre">tensorflow::INFO</span></code> level by default so to see VLOGs set <code class="docutils literal notranslate"><span class="pre">TF_CPP_MIN_LOG_LEVEL=0</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">XLA_DUMP_HLO_GRAPH</span></code>: If set to <code class="docutils literal notranslate"><span class="pre">=1</span></code> in case of a compilation or execution error the
offending HLO graph will be dumped as part of the runtime error raised by <code class="docutils literal notranslate"><span class="pre">xla_util.cc</span></code>.</p></li>
</ul>
</div>
<div class="section" id="retrieving-stack-traces">
<h3>Retrieving Stack Traces<a class="headerlink" href="#retrieving-stack-traces" title="Permalink to this headline">¶</a></h3>
<p>In the event that the <em>PyTorch</em> process is hanging, it might be useful to include the stack
traces together with the GitHub issue.</p>
<p>First thing is to find out which PID the <em>PyTorch</em> process is associated with. Using the <code class="docutils literal notranslate"><span class="pre">ps</span></code>
command it is possible to find that information. It will be a <em>python</em> process running your
main <em>python</em> file.</p>
<p>In order to allow <em>GDB</em> to attach a user process the following command should be run as root:</p>
<div class="highlight-Shell notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="m">0</span> &gt; /proc/sys/kernel/yama/ptrace_scope
</pre></div>
</div>
<p>The above command remains active until the machine is rebooted.</p>
<p>The, given the PID, it is possible to grab the stack traces with the following command:</p>
<div class="highlight-Shell notranslate"><div class="highlight"><pre><span></span>./scripts/dump_stacks.py PID &gt; /tmp/stack-traces.log
</pre></div>
</div>
</div>
</div>
<div class="section" id="using-debug-run-py-to-collect-debug-information">
<h2>Using debug_run.py To Collect Debug Information<a class="headerlink" href="#using-debug-run-py-to-collect-debug-information" title="Permalink to this headline">¶</a></h2>
<p>A utility is provided in <code class="docutils literal notranslate"><span class="pre">scripts/debug_run.py</span></code> which can be used to create a <code class="docutils literal notranslate"><span class="pre">tar.gz</span></code>
archive with the information required to debug <em>PyTorch/XLA</em> executions.</p>
<p>Example:</p>
<div class="highlight-Shell notranslate"><div class="highlight"><pre><span></span>./scripts/debug_run.py --outfile /tmp/debug_run.tar.gz -- python -u SCRIPT <span class="o">[</span>ARGS...<span class="o">]</span>
</pre></div>
</div>
<p>The <em>python</em> <code class="docutils literal notranslate"><span class="pre">-u</span></code> flag is suggested to disable buffering so that captured logs are correctly
interleaved (otherwise STDOUT will be rendered after all STDERR).</p>
<p>The above command line example will leave the temporary folder containing the archived
information on the filesystem. Use the <code class="docutils literal notranslate"><span class="pre">--tidy</span></code> flag to have that removed on exit:</p>
<div class="highlight-Shell notranslate"><div class="highlight"><pre><span></span>./scripts/debug_run.py --tidy --outfile /tmp/debug_run.tar.gz -- python -u SCRIPT <span class="o">[</span>ARGS...<span class="o">]</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">debug_run.tar.gz</span></code> file should then be attached to bug reports when necessary.</p>
<p>Since the script will collect a lot of data, it should usually be let run for no more
than hundred steps or so.</p>
<p>If the SCRIPT has arguments to control the number of steps, those should be used,
otherwise hitting <code class="docutils literal notranslate"><span class="pre">CTRL^C</span></code> will interrupt the run.</p>
<p>It is also sugested to run in single-core mode, to minimize the amount of data.
Running in single-core mode is also strongly suggested when debugging execution issues.</p>
</div>
<div class="section" id="common-issues">
<h2>Common Issues<a class="headerlink" href="#common-issues" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Missing</span> <span class="pre">XLA</span> <span class="pre">configuration</span></code> error message: You need to set <code class="docutils literal notranslate"><span class="pre">XRT_TPU_CONFIG</span></code> if using TPUs. If using GPUs set <code class="docutils literal notranslate"><span class="pre">GPU_NUM_DEVICES=N</span></code> for <code class="docutils literal notranslate"><span class="pre">N</span></code> number of GPUs. If using CPUs set <code class="docutils literal notranslate"><span class="pre">XRT_DEVICE_MAP=&quot;CPU:0;/job:localservice/replica:0/task:0/device:XLA_CPU:0&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">XRT_WORKERS=&quot;localservice:0;grpc://localhost:9002&quot;</span></code></p></li>
</ul>
</div>
</div>
<div class="section" id="experimental-pjrt-runtime-support">
<h1>Experimental PjRt Runtime Support<a class="headerlink" href="#experimental-pjrt-runtime-support" title="Permalink to this headline">¶</a></h1>
<p>The PyTorch/XLA team is currently migrating from the currently-supported XRT
runtime to the <a class="reference external" href="https://github.com/tensorflow/tensorflow/tree/master/tensorflow/compiler/xla/pjrt">PjRt
runtime</a>
used by <a class="reference external" href="https://github.com/google/jax">JAX</a>. Although PjRt may work on TPU v2
and v3, we plan on making PjRt the officially supported runtime for PyTorch/XLA
on TPU v4 and future generations of TPU.</p>
<p>PjRt is available as an <em>experimental preview</em> in PyTorch/XLA r1.13. The
PyTorch/XLA team will provide limited support on a best-effort basis during this
preview. If you encounter a bug with PjRt, please file an issue on GitHub with
the <code class="docutils literal notranslate"><span class="pre">runtime</span></code> tag.</p>
<p><strong>This preview is mainly targeted at TPU v4</strong>. In most cases, we expect that you can
re-use your existing PyTorch/XLA code for TPU v4 with no changes. You may be able to
adapt your v2 or v3 workload to PjRt with some caveats (see below).</p>
<div class="section" id="quickstart">
<h2>Quickstart<a class="headerlink" href="#quickstart" title="Permalink to this headline">¶</a></h2>
<p>To start using PjRt with PyTorch/XLA, all you need to do is set the
<code class="docutils literal notranslate"><span class="pre">PJRT_DEVICE</span></code> environment variable. If you’re working on a TPU v2 or v3, keep
reading to learn about the differences between TPU v2 and v3 and v4.</p>
<div class="section" id="cpu">
<h3>CPU<a class="headerlink" href="#cpu" title="Permalink to this headline">¶</a></h3>
<p>On any machine with PyTorch/XLA installed, you can run our MNIST example on CPU
like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PJRT_DEVICE</span><span class="o">=</span><span class="n">CPU</span> <span class="n">python3</span> <span class="n">xla</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">test_train_mp_mnist</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">fake_data</span>
</pre></div>
</div>
</div>
<div class="section" id="v4-tpu">
<h3>v4 TPU<a class="headerlink" href="#v4-tpu" title="Permalink to this headline">¶</a></h3>
<p>To create a new TPU with PyTorch/XLA r1.13 installed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>gcloud alpha compute tpus tpu-vm create $USER-pjrt --accelerator-type=v4-8 --version=tpu-vm-v4-pt-1.13 --zone=us-central2-b --project=$PROJECT
</pre></div>
</div>
<p>On a v4-8, you can run our ResNet50 example like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="o">--</span><span class="n">depth</span><span class="o">=</span><span class="mi">1</span> <span class="o">--</span><span class="n">branch</span> <span class="n">r1</span><span class="o">.</span><span class="mi">13</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">pytorch</span><span class="o">/</span><span class="n">xla</span><span class="o">.</span><span class="n">git</span>
<span class="n">PJRT_DEVICE</span><span class="o">=</span><span class="n">TPU</span> <span class="n">python3</span> <span class="n">xla</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">test_train_mp_imagenet</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">fake_data</span> <span class="o">--</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span> <span class="o">--</span><span class="n">num_epochs</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p>By default, PjRt will use all TPU chips. To use only one TPU chip, configure
<code class="docutils literal notranslate"><span class="pre">TPU_PROCESS_BOUNDS</span></code> and <code class="docutils literal notranslate"><span class="pre">TPU_VISIBLE_CHIPS</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TPU_PROCESS_BOUNDS</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span> <span class="n">TPU_VISIBLE_CHIPS</span><span class="o">=</span><span class="mi">0</span> <span class="n">PJRT_DEVICE</span><span class="o">=</span><span class="n">TPU</span> <span class="n">python3</span> <span class="n">xla</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">test_train_mp_imagenet</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">fake_data</span> <span class="o">--</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">256</span> <span class="o">--</span><span class="n">num_epochs</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p>Note: <code class="docutils literal notranslate"><span class="pre">xmp.spawn</span></code>’s <code class="docutils literal notranslate"><span class="pre">nprocs</span></code> argument is not implemented for PjRt.</p>
<div class="section" id="pods">
<h4>Pods<a class="headerlink" href="#pods" title="Permalink to this headline">¶</a></h4>
<p>On TPU Pods, use <code class="docutils literal notranslate"><span class="pre">gcloud</span></code> to run your command on each TPU in parallel:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>gcloud alpha compute tpus tpu-vm ssh $USER-pjrt --zone=us-central2-b --project=$PROJECT --worker=all --command=&quot;git clone --depth=1 --branch r1.13 https://github.com/pytorch/xla.git&quot;
gcloud alpha compute tpus tpu-vm ssh $USER-pjrt --zone=us-central2-b --project=$PROJECT --worker=all --command=&quot;PJRT_DEVICE=TPU python3 xla/test/test_train_mp_imagenet.py --fake_data --batch_size=256 --num_epochs=1&quot;
</pre></div>
</div>
</div>
</div>
<div class="section" id="gpu">
<h3>GPU<a class="headerlink" href="#gpu" title="Permalink to this headline">¶</a></h3>
<p>Coming soon in a future release!</p>
</div>
</div>
<div class="section" id="key-differences-from-xrt">
<h2>Key differences from XRT<a class="headerlink" href="#key-differences-from-xrt" title="Permalink to this headline">¶</a></h2>
<p>Although in most cases we expect PjRt and XRT to work mostly interchangeably
from the end-user’s perspective (especially on TPU v4), there are some subtle
differences that are important to keep in mind. Importantly, XRT was designed
around the TPU Node architecture, so it will always spawn a client and a server
process, even on TPU VMs. Thus, every batch of inputs has additional latency
from serializing and deserializing data.</p>
<p>PjRt uses the local device directly with no intermediate server process. In the
default configuration, PjRt will create one process per TPU chip, or 4 processes
per TPU host. See the <a class="reference external" href="https://cloud.google.com/tpu/docs/system-architecture-tpu-vm">Cloud TPU documentation</a>
for more information about TPU architecture.</p>
<ul class="simple">
<li><p>Performance gains are possible for workloads constrained by data transfer
speeds.</p></li>
<li><p>Under XRT, the server process is the only process that interacts with the TPU
devices, and client processes don’t have direct access to the TPU devices.
When profiling a single-host TPU (e.g. v3-8 or v4-8), you would normally see 8
device traces (one for each TPU core). With PjRt, each process has one chip,
and a profile from that process will show only 2 TPU cores.</p></li>
<li><p>For the same reason, profiling does not work on TPU Pods with XRT, because the
server process runs independently from the user’s model code. PjRt does not
have that constraint, so it is possible to profile 2 TPU cores per process in
a TPU Pod.</p></li>
<li><p>PjRt only supports the TPU VM architecture and we have no plans to support the
TPU Node architecture with PjRt.</p></li>
<li><p>Runtime configuration is significantly simpler with PjRt. <code class="docutils literal notranslate"><span class="pre">xla_dist</span></code> is not
required to run TPU Pod workloads. Instead, copy your code to each TPU host
(<cite>``gcloud compute tpus tpu-vm scp`</cite> &lt;<a class="reference external" href="https://cloud.google.com/sdk/gcloud/reference/alpha/compute/tpus/tpu-vm/scp">https://cloud.google.com/sdk/gcloud/reference/alpha/compute/tpus/tpu-vm/scp</a>&gt;`_) and run the code on each host in
parallel (e.g. <cite>``gcloud compute tpus tpu-vm ssh –workers=all
–command=”PJRT_DEVICE=TPU python run.py”`</cite> &lt;<a class="reference external" href="https://cloud.google.com/sdk/gcloud/reference/alpha/compute/tpus/tpu-vm/ssh">https://cloud.google.com/sdk/gcloud/reference/alpha/compute/tpus/tpu-vm/ssh</a>&gt;`_)</p></li>
</ul>
</div>
<div class="section" id="tpus-v2-v3-vs-v4">
<h2>TPUs v2/v3 vs v4<a class="headerlink" href="#tpus-v2-v3-vs-v4" title="Permalink to this headline">¶</a></h2>
<p>On TPU v4, one TPU chip is represented to PyTorch as one device, while on TPUs
v2/v3, one TPU chip is represented to PyTorch as <em>two</em> devices. It is not
possible to access the same TPU chip from multiple processes, so workloads must
be able to handle two devices per process. The easiest way to handle this is to
spawn two threads per process on TPU v2/v3, which is done automatically by
<code class="docutils literal notranslate"><span class="pre">xmp.spawn</span></code> when using PjRt. With multiple threads per process, multiple replicas
will share global state, causing the following known issues:</p>
<ul class="simple">
<li><p>Threads will share the same <code class="docutils literal notranslate"><span class="pre">torch</span></code> random seed used for parameter
initialization. If you relied on each process having the same random seed for
deterministic parameter initialization, you will have to synchronize module
parameters via collective broadcasting instead (e.g.
<code class="docutils literal notranslate"><span class="pre">pjrt.broadcast_master_param(model)</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">torch.distributed</span></code> uses a global process group and does not support
multi-threading, so the <code class="docutils literal notranslate"><span class="pre">xla</span></code> <code class="docutils literal notranslate"><span class="pre">torch.distributed</span></code> backend will not work with
PjRt and TPU v2 and v3 at this time.</p></li>
<li><p>Because the current implementation of <code class="docutils literal notranslate"><span class="pre">xm.rendezvous</span></code> for PjRt relies on
<code class="docutils literal notranslate"><span class="pre">torch.distributed</span></code>, <code class="docutils literal notranslate"><span class="pre">xm.rendezvous</span></code> is not supported with PjRt on TPU v2 and
v3.</p></li>
</ul>
<div class="section" id="compatible-examples">
<h3>Compatible examples<a class="headerlink" href="#compatible-examples" title="Permalink to this headline">¶</a></h3>
<p>For an overview of the changes required to migrate from TPU v2/v3 to v4, compare
our MNIST (<a class="reference external" href="../test/test_train_mp_mnist.py">XRT</a>,
<a class="reference external" href="../test/pjrt/test_train_pjrt_mnist.py">PjRt</a>) and ImageNet
(<a class="reference external" href="../test/test_train_mp_imagenet.py">XRT</a>,
<a class="reference external" href="../test/pjrt/test_train_pjrt_imagenet.py">PjRt</a>) examples.</p>
<p>The PjRt MNIST and ImageNet examples are compatible with all versions of TPU.
Use the following commands to run them on a single-host TPU (e.g. v3-8 or v4-8).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PJRT_DEVICE</span><span class="o">=</span><span class="n">TPU</span> <span class="n">python3</span> <span class="n">xla</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">pjrt</span><span class="o">/</span><span class="n">test_train_pjrt_mnist</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">fake_data</span>
<span class="n">PJRT_DEVICE</span><span class="o">=</span><span class="n">TPU</span> <span class="n">python3</span> <span class="n">xla</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">pjrt</span><span class="o">/</span><span class="n">test_train_pjrt_imagenet</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">fake_data</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="pjrt-and-ddp">
<h2>PjRt and DDP<a class="headerlink" href="#pjrt-and-ddp" title="Permalink to this headline">¶</a></h2>
<p>PjRt composes really well with [the new experimental
torch.nn.parallel.DistributedDataParallel feature] (./ddp.md) on TPU V4. Just
run the DDP script as usual but with <code class="docutils literal notranslate"><span class="pre">PJRT_DEVICE=TPU</span></code>. Here is a full example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PJRT_DEVICE</span><span class="o">=</span><span class="n">TPU</span> <span class="n">MASTER_ADDR</span><span class="o">=</span><span class="n">localhost</span> <span class="n">MASTER_PORT</span><span class="o">=</span><span class="mi">6000</span> <span class="n">python</span> <span class="n">xla</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">test_train_mp_mnist</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">ddp</span> <span class="o">--</span><span class="n">fake_data</span> <span class="o">--</span><span class="n">num_epochs</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Caveat: for TPU V2 and V3, however, XRT will still be needed to run DDP.</p>
</div>
</div>
<div class="section" id="how-to-do-distributeddataparallel">
<h1>How to do <code class="docutils literal notranslate"><span class="pre">DistributedDataParallel</span></code><a class="headerlink" href="#how-to-do-distributeddataparallel" title="Permalink to this headline">¶</a></h1>
<p>This document shows how to use torch.nn.parallel.DistributedDataParallel in xla,
and further describes its difference against the native xla data parallel
approach.</p>
<div class="section" id="background-motivation">
<h2>Background / Motivation<a class="headerlink" href="#background-motivation" title="Permalink to this headline">¶</a></h2>
<p>Customers have long requested the ability to use PyTorch’s
DistributedDataParallel API with xla. And here we enable it as an experimental
feature.</p>
</div>
<div class="section" id="how-to-use-distributeddataparallel">
<h2>How to use DistributedDataParallel<a class="headerlink" href="#how-to-use-distributeddataparallel" title="Permalink to this headline">¶</a></h2>
<p>For those who switched from the PyTorch eager mode to XLA, here are all the
changes you need to do to convert your eager DDP model into XLA model. We assume
that you already know how to use XLA <a class="reference external" href="../API_GUIDE.md#running-on-a-single-xla-device">on a single
device</a>.</p>
<ol class="arabic simple">
<li><p>Import xla specific distributed packages:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch_xla.core.xla_model</span> <span class="k">as</span> <span class="nn">xm</span>
<span class="kn">import</span> <span class="nn">torch_xla.distributed.xla_backend</span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>Init xla process group similar to other process groups such as nccl and gloo.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dist</span><span class="o">.</span><span class="n">init_process_group</span><span class="p">(</span><span class="s2">&quot;xla&quot;</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span><span class="o">=</span><span class="n">world_size</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>Use xla specific APIs to get rank and world_size if you need to.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">new_rank</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">get_ordinal</span><span class="p">()</span>
<span class="n">world_size</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xrt_world_size</span><span class="p">()</span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>Pass <code class="docutils literal notranslate"><span class="pre">gradient_as_bucket_view=True</span></code> to the DDP wrapper.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ddp_model</span> <span class="o">=</span> <span class="n">DDP</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">gradient_as_bucket_view</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple">
<li><p>Finally launch your model with xla specific launcher.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xmp</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">demo_fn</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we have put everything together (the example is actually taken from the
<a class="reference external" href="https://pytorch.org/tutorials/intermediate/ddp_tutorial.html">DDP tutorial</a>).
The way you code it is pretty similar to the eager experience. Just with xla
specific touches on a single device plus the above five changes to your script.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.distributed</span> <span class="k">as</span> <span class="nn">dist</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="nn">optim</span>

<span class="kn">from</span> <span class="nn">torch.nn.parallel</span> <span class="kn">import</span> <span class="n">DistributedDataParallel</span> <span class="k">as</span> <span class="n">DDP</span>

<span class="c1"># additional imports for xla</span>
<span class="kn">import</span> <span class="nn">torch_xla.core.xla_model</span> <span class="k">as</span> <span class="nn">xm</span>
<span class="kn">import</span> <span class="nn">torch_xla.distributed.xla_backend</span>
<span class="kn">import</span> <span class="nn">torch_xla.distributed.xla_multiprocessing</span> <span class="k">as</span> <span class="nn">xmp</span>

<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MASTER_ADDR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MASTER_PORT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;12355&#39;</span>

    <span class="c1"># initialize the xla process group</span>
    <span class="n">dist</span><span class="o">.</span><span class="n">init_process_group</span><span class="p">(</span><span class="s2">&quot;xla&quot;</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span><span class="o">=</span><span class="n">world_size</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">cleanup</span><span class="p">():</span>
    <span class="n">dist</span><span class="o">.</span><span class="n">destroy_process_group</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">ToyModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ToyModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">1000000</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net1</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">demo_basic</span><span class="p">(</span><span class="n">rank</span><span class="p">):</span>
    <span class="c1"># xla specific APIs to get rank, world_size.</span>
    <span class="n">new_rank</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">get_ordinal</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">new_rank</span> <span class="o">==</span> <span class="n">rank</span>
    <span class="n">world_size</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xrt_world_size</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running basic DDP example on rank </span><span class="si">{</span><span class="n">rank</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">setup</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">world_size</span><span class="p">)</span>

    <span class="c1"># create model and move it to XLA device</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">xm</span><span class="o">.</span><span class="n">xla_device</span><span class="p">()</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ToyModel</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="c1"># currently, graident_as_bucket_view is needed to make DDP work for xla</span>
    <span class="n">ddp_model</span> <span class="o">=</span> <span class="n">DDP</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">gradient_as_bucket_view</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">()</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">ddp_model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">ddp_model</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">loss_fn</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="c1"># xla specific API to execute the graph</span>
    <span class="n">xm</span><span class="o">.</span><span class="n">mark_step</span><span class="p">()</span>

    <span class="n">cleanup</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">run_demo</span><span class="p">(</span><span class="n">demo_fn</span><span class="p">):</span>
    <span class="c1"># xla specific launcher</span>
    <span class="n">xmp</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">demo_fn</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">run_demo</span><span class="p">(</span><span class="n">demo_basic</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="benchmarking">
<h2>Benchmarking<a class="headerlink" href="#benchmarking" title="Permalink to this headline">¶</a></h2>
<div class="section" id="resnet50-with-fake-data">
<h3>Resnet50 with fake data<a class="headerlink" href="#resnet50-with-fake-data" title="Permalink to this headline">¶</a></h3>
<p>The following results are collected with the command: <code class="docutils literal notranslate"><span class="pre">python</span>
<span class="pre">test/test_train_mp_imagenet.py</span> <span class="pre">--fake_data</span> <span class="pre">--model=resnet50</span> <span class="pre">--num_epochs=1</span></code> on a
TPU VM V3-8 environment with ToT PyTorch and PyTorch/XLA. And the statistical
metrics are produced by using the script in this <a class="reference external" href="https://github.com/pytorch/xla/pull/4107">pull
request</a>. The unit for the rate is
images per second.</p>
<table>
  <tr>
   <td>Type
   </td>
   <td>Mean
   </td>
   <td>Median
   </td>
   <td>90th %
   </td>
   <td>Std Dev
   </td>
   <td>CV
   </td>
  </tr>
  <tr>
   <td>xm.optimizer_step
   </td>
   <td>418.54
   </td>
   <td>419.22
   </td>
   <td>430.40
   </td>
   <td>9.76
   </td>
   <td>0.02
   </td>
  </tr>
  <tr>
   <td>DDP
   </td>
   <td>395.97
   </td>
   <td>395.54
   </td>
   <td>407.13
   </td>
   <td>7.60
   </td>
   <td>0.02
   </td>
  </tr>
</table><p>The performance difference between our native approach for distributed data
parallel and DistributedDataParallel wrapper is: 1 - 395.97 / 418.54 = 5.39%.
This result seems reasonable given the DDP wrapper introduces extra overheads on
tracing the DDP runtime.</p>
</div>
<div class="section" id="mnist-with-fake-data">
<h3>MNIST with fake data<a class="headerlink" href="#mnist-with-fake-data" title="Permalink to this headline">¶</a></h3>
<p>The following results are collected with the command: <code class="docutils literal notranslate"><span class="pre">python</span>
<span class="pre">test/test_train_mp_mnist.py</span> <span class="pre">--fake_data</span></code> on a TPU VM V3-8 environment with ToT
PyTorch and PyTorch/XLA. And the statistical metrics are produced by using the
script in this <a class="reference external" href="https://github.com/pytorch/xla/pull/4107">pull request</a>. The
unit for the rate is images per second.</p>
<table>
  <tr>
   <td>Type
   </td>
   <td>Mean
   </td>
   <td>Median
   </td>
   <td>90th %
   </td>
   <td>Std Dev
   </td>
   <td>CV
   </td>
  </tr>
  <tr>
   <td>xm.optimizer_step
   </td>
   <td>17864.19
   </td>
   <td>20108.96
   </td>
   <td>24351.74
   </td>
   <td>5866.83
   </td>
   <td>0.33
   </td>
  </tr>
  <tr>
   <td>DDP
   </td>
   <td>10701.39
   </td>
   <td>11770.00
   </td>
   <td>14313.78
   </td>
   <td>3102.92
   </td>
   <td>0.29
   </td>
  </tr>
</table><p>The performance difference between our native approach for distributed data
parallel and DistributedDataParallel wrapper is: 1 - 14313.78 / 24351.74 =
41.22%. Here we compare 90th % instead since the dataset is small and first a
few rounds are heavily impacted by data loading. This slowdown is huge but makes
sense given the model is small. The additional DDP runtime tracing overhead is
hard to amortize.</p>
</div>
<div class="section" id="mnist-with-real-data">
<h3>MNIST with real data<a class="headerlink" href="#mnist-with-real-data" title="Permalink to this headline">¶</a></h3>
<p>The following results are collected with the command: <code class="docutils literal notranslate"><span class="pre">python</span>
<span class="pre">test/test_train_mp_mnist.py</span> <span class="pre">--logdir</span> <span class="pre">mnist/</span></code> on a TPU VM V3-8 environment with
ToT PyTorch and PyTorch/XLA.</p>
<a class="reference external image-reference" href="assets/ddp_md_mnist_with_real_data.png"><img alt="learning_curves" src="assets/ddp_md_mnist_with_real_data.png" /></a>
<p>And we can observe that the DDP wrapper converges slower than the native XLA
approach even though it still achieves a high accuracy rate at 97.48% at the
end. (The native approach achieves 99%.)</p>
</div>
</div>
<div class="section" id="disclaimer">
<h2>Disclaimer<a class="headerlink" href="#disclaimer" title="Permalink to this headline">¶</a></h2>
<p>This feature is still experimental and under active development. Use it in
cautions and feel free to file any bugs to the <a class="reference external" href="https://github.com/pytorch/xla/">xla github
repo</a>. For those who are interested in the
native xla data parallel approach, here is the
<a class="reference external" href="../API_GUIDE.md#running-on-multiple-xla-devices-with-multi-processing">tutorial</a>.</p>
<p>Here are some of the known issues that are under investigation:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">gradient_as_bucket_view=True</span></code> needs to be enforced.</p></li>
<li><p>There are some issues while being used with <code class="docutils literal notranslate"><span class="pre">torch.utils.data.DataLoader</span></code>. <code class="docutils literal notranslate"><span class="pre">​​test_train_mp_mnist.py</span></code> with real data crashes before exiting.</p></li>
</ul>
</div>
<div class="section" id="fully-sharded-data-parallel-fsdp-in-pytorch-xla">
<h2>Fully Sharded Data Parallel (FSDP) in PyTorch XLA<a class="headerlink" href="#fully-sharded-data-parallel-fsdp-in-pytorch-xla" title="Permalink to this headline">¶</a></h2>
<p>Fully Sharded Data Parallel (FSDP) in PyTorch XLA is a utility for sharding Module parameters across data-parallel workers.</p>
<p>Example usage:</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch_xla.core.xla_model</span> <span class="k">as</span> <span class="nn">xm</span>
<span class="kn">from</span> <span class="nn">torch_xla.distributed.fsdp</span> <span class="kn">import</span> <span class="n">XlaFullyShardedDataParallel</span> <span class="k">as</span> <span class="n">FSDP</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">FSDP</span><span class="p">(</span><span class="n">my_module</span><span class="p">)</span>
<span class="n">optim</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">loss</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="n">optim</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</pre></div>
</div>
<p>It is also possible to shard individual layers separately and have an outer wrapper handle any leftover parameters.</p>
<p>Notes:</p>
<ul>
<li><p>The <code class="docutils literal notranslate"><span class="pre">XlaFullyShardedDataParallel</span></code> class supports both the ZeRO-2 optimizer (sharding gradients and optimizer states) and the ZeRO-3 optimizer (sharding parameters, gradients, and optimizer states) in <a class="reference external" href="https://arxiv.org/abs/1910.02054">https://arxiv.org/abs/1910.02054</a>.</p>
<ul class="simple">
<li><p>The ZeRO-3 optimizer should be implemented via nested FSDP with <code class="docutils literal notranslate"><span class="pre">reshard_after_forward=True</span></code>. See <code class="docutils literal notranslate"><span class="pre">test/test_train_mp_mnist_fsdp_with_ckpt.py</span></code> and <code class="docutils literal notranslate"><span class="pre">test/test_train_mp_imagenet_fsdp.py</span></code> for an example.</p></li>
<li><p>For large models that cannot fit into a single TPU memory or the host CPU memory, one should interleave submodule construction with inner FSDP wrapping. See <cite>``FSDPViTModel`</cite> &lt;<a class="reference external" href="https://github.com/ronghanghu/vit_10b_fsdp_example/blob/master/run_vit_training.py">https://github.com/ronghanghu/vit_10b_fsdp_example/blob/master/run_vit_training.py</a>&gt;`_ for an example.</p></li>
</ul>
</li>
<li><p>a simple wrapper <code class="docutils literal notranslate"><span class="pre">checkpoint_module</span></code> is provided (based on <code class="docutils literal notranslate"><span class="pre">torch_xla.utils.checkpoint.checkpoint</span></code> from <a class="reference external" href="https://github.com/pytorch/xla/pull/3524">https://github.com/pytorch/xla/pull/3524</a>) to perform <a class="reference external" href="https://spell.ml/blog/gradient-checkpointing-pytorch-YGypLBAAACEAefHs">gradient checkpointing</a> over a given <code class="docutils literal notranslate"><span class="pre">nn.Module</span></code> instance. See <code class="docutils literal notranslate"><span class="pre">test/test_train_mp_mnist_fsdp_with_ckpt.py</span></code> and <code class="docutils literal notranslate"><span class="pre">test/test_train_mp_imagenet_fsdp.py</span></code> for an example.</p></li>
<li><p>When stepping the optimizer, directly call <code class="docutils literal notranslate"><span class="pre">optimizer.step</span></code> and do not call <code class="docutils literal notranslate"><span class="pre">xm.optimizer_step</span></code>. The latter reduces the gradient across ranks, which is not needed for FSDP (where the parameters are already sharded).</p></li>
<li><p>When saving model and optimizer checkpoints during training, each training process needs to save its own checkpoint of the (sharded) model and optimizer state dicts (use <code class="docutils literal notranslate"><span class="pre">master_only=False</span></code> and set different paths for each rank in <code class="docutils literal notranslate"><span class="pre">xm.save</span></code>). When resuming, it needs to load the checkpoint for the corresponding rank.</p></li>
<li><p>Please also save <code class="docutils literal notranslate"><span class="pre">model.get_shard_metadata()</span></code> along with <code class="docutils literal notranslate"><span class="pre">model.state_dict()</span></code> as follows and use <code class="docutils literal notranslate"><span class="pre">consolidate_sharded_model_checkpoints</span></code> to stitch the sharded model checkpoints together into a full model state dict. See <code class="docutils literal notranslate"><span class="pre">test/test_train_mp_mnist_fsdp_with_ckpt.py</span></code> for an example.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ckpt</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
  <span class="s1">&#39;shard_metadata&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">get_shard_metadata</span><span class="p">(),</span>
  <span class="s1">&#39;optimizer&#39;</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
<span class="p">}</span>
<span class="n">ckpt_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/tmp/rank-</span><span class="si">{</span><span class="n">xm</span><span class="o">.</span><span class="n">get_ordinal</span><span class="p">()</span><span class="si">}</span><span class="s1">-of-</span><span class="si">{</span><span class="n">xm</span><span class="o">.</span><span class="n">xrt_world_size</span><span class="p">()</span><span class="si">}</span><span class="s1">.pth&#39;</span>
<span class="n">xm</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">ckpt</span><span class="p">,</span> <span class="n">ckpt_path</span><span class="p">,</span> <span class="n">master_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>The checkpoint consolidation script can also be launched from the command line as follows.
.. code-block:: bash</p>
<blockquote>
<div><p># consolidate the saved checkpoints via command line tool
python3 -m torch_xla.distributed.fsdp.consolidate_sharded_ckpts –ckpt_prefix /path/to/your_sharded_checkpoint_files –ckpt_suffix “_rank-<em>-of-</em>.pth”</p>
</div></blockquote>
</li>
</ul>
<p>The implementation of this class is largely inspired by and mostly follows the structure of <code class="docutils literal notranslate"><span class="pre">fairscale.nn.FullyShardedDataParallel</span></code> in <a class="reference external" href="https://fairscale.readthedocs.io/en/stable/api/nn/fsdp.html">https://fairscale.readthedocs.io/en/stable/api/nn/fsdp.html</a>. One of the biggest differences from <code class="docutils literal notranslate"><span class="pre">fairscale.nn.FullyShardedDataParallel</span></code> is that in XLA we don’t have explicit parameter storage, so here we resort to a different approach to free full parameters for ZeRO-3.</p>
<hr class="docutils" />
<div class="section" id="example-training-scripts-on-mnist-and-imagenet">
<h3>Example training scripts on MNIST and ImageNet<a class="headerlink" href="#example-training-scripts-on-mnist-and-imagenet" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>MNIST: <cite>``test/test_train_mp_mnist_fsdp_with_ckpt.py`</cite> &lt;<a class="reference external" href="https://github.com/pytorch/xla/blob/master/test/test_train_mp_mnist_fsdp_with_ckpt.py">https://github.com/pytorch/xla/blob/master/test/test_train_mp_mnist_fsdp_with_ckpt.py</a>&gt;`_ (it also tests checkpoint consolidation)</p></li>
<li><p>ImageNet: <cite>``test/test_train_mp_imagenet_fsdp.py`</cite> &lt;<a class="reference external" href="https://github.com/pytorch/xla/blob/master/test/test_train_mp_imagenet_fsdp.py">https://github.com/pytorch/xla/blob/master/test/test_train_mp_imagenet_fsdp.py</a>&gt;`_</p></li>
</ul>
<div class="section" id="installation">
<h4>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h4>
<p>FSDP is available on PyTorch/XLA 1.12 release and newer nightly. Please refer to <a class="reference external" href="https://github.com/pytorch/xla#-available-images-and-wheels">https://github.com/pytorch/xla#-available-images-and-wheels</a> for installation guide.</p>
</div>
<div class="section" id="clone-pytorch-xla-repo">
<h4>Clone PyTorch/XLA repo<a class="headerlink" href="#clone-pytorch-xla-repo" title="Permalink to this headline">¶</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone --recursive https://github.com/pytorch/pytorch
<span class="nb">cd</span> pytorch/
git clone --recursive https://github.com/pytorch/xla.git
<span class="nb">cd</span> ~/
</pre></div>
</div>
</div>
<div class="section" id="train-mnist-on-v3-8-tpu">
<h4>Train MNIST on v3-8 TPU<a class="headerlink" href="#train-mnist-on-v3-8-tpu" title="Permalink to this headline">¶</a></h4>
<p>It gets around 98.9 accuracy for 2 epochs:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3 ~/pytorch/xla/test/test_train_mp_mnist_fsdp_with_ckpt.py <span class="se">\</span>
  --batch_size <span class="m">16</span> --drop_last --num_epochs <span class="m">2</span> <span class="se">\</span>
  --use_nested_fsdp --use_gradient_checkpointing
</pre></div>
</div>
<p>This script automatically tests checkpoint consolidation at the end. You can also manually consolidate the sharded checkpoints via</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># consolidate the saved checkpoints via command line tool</span>
python3 -m torch_xla.distributed.fsdp.consolidate_sharded_ckpts <span class="se">\</span>
  --ckpt_prefix /tmp/mnist-fsdp/final_ckpt <span class="se">\</span>
  --ckpt_suffix <span class="s2">&quot;_rank-*-of-*.pth&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="train-imagenet-with-resnet-50-on-v3-8-tpu">
<h4>Train ImageNet with ResNet-50 on v3-8 TPU<a class="headerlink" href="#train-imagenet-with-resnet-50-on-v3-8-tpu" title="Permalink to this headline">¶</a></h4>
<p>It gets around 75.9 accuracy for 100 epochs; download <a class="reference external" href="https://github.com/pytorch/examples/tree/master/imagenet#requirements">ImageNet-1k</a> to <code class="docutils literal notranslate"><span class="pre">/datasets/imagenet-1k</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3 ~/pytorch/xla/test/test_train_mp_imagenet_fsdp.py <span class="se">\</span>
  --datadir /datasets/imagenet-1k --drop_last <span class="se">\</span>
  --model resnet50 --test_set_batch_size <span class="m">64</span> --eval_interval <span class="m">10</span> <span class="se">\</span>
  --lr <span class="m">0</span>.4 --batch_size <span class="m">128</span> --num_warmup_epochs <span class="m">5</span> --lr_scheduler_divide_every_n_epochs <span class="m">30</span> --lr_scheduler_divisor <span class="m">10</span> --num_epochs <span class="m">100</span> <span class="se">\</span>
  --use_nested_fsdp
</pre></div>
</div>
<p>You can also add <code class="docutils literal notranslate"><span class="pre">--use_gradient_checkpointing</span></code> (which needs to be used along with <code class="docutils literal notranslate"><span class="pre">--use_nested_fsdp</span></code>) to apply gradient checkpointing on the residual blocks.</p>
</div>
</div>
<hr class="docutils" />
<div class="section" id="example-training-scripts-on-tpu-pod-with-10-billion-parameters">
<h3>Example training scripts on TPU pod (with 10 billion parameters)<a class="headerlink" href="#example-training-scripts-on-tpu-pod-with-10-billion-parameters" title="Permalink to this headline">¶</a></h3>
<p>To train large models that cannot fit into a single TPU, one should use nested FSDP (wrapping sub-modules with inner FSDP when building the entire model) to implement the ZeRO-3 algorithm.</p>
<p>Please see <a class="reference external" href="https://github.com/ronghanghu/vit_10b_fsdp_example">https://github.com/ronghanghu/vit_10b_fsdp_example</a> for an example of sharded training of a Vision Transformer (ViT) model using this XLA FSDP PR.</p>
</div>
</div>
</div>
<div class="section" id="op-lowering-guide">
<h1>OP Lowering Guide<a class="headerlink" href="#op-lowering-guide" title="Permalink to this headline">¶</a></h1>
<div class="section" id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<p>PyTorch wraps the C++ ATen tensor library that offers a wide range of operations implemented on GPU and CPU. Pytorch/XLA is a PyTorch extension; one of its purposes is to convert PyTorch operations to XLA operations. Lowering defines a process of converting a higher-level representation to a lower-level representation. In this document, I will refer to the process of converting PyTorch operation to XLA operation as the lowering. XLA Compiler will also lower XlaOp to HLO, but that’s beyond the scope of this documentation. We will forward operations that we haven’t provided an XLA lowering yet to CPU and call ATen implementations. Operations that are forwarded to the CPU will cause a significant slowdown. We must lower all operations used in the model to achieve the best performance.</p>
</div>
<div class="section" id="before-you-start">
<h2>Before you start<a class="headerlink" href="#before-you-start" title="Permalink to this headline">¶</a></h2>
<p>You should follow the instructions in <a class="reference external" href="https://github.com/pytorch/xla/blob/master/CONTRIBUTING.md">here</a> to install required dependencies and build pytorch and pytorch/XLA from the source. You do not need access to TPU to implement the lowering. It is recommended to experiment on a workstation and configure it to use XLA:CPU. You can configure Pytorch/XLA to use XLA:CPU by running</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">XRT_DEVICE_MAP</span><span class="o">=</span><span class="s2">&quot;CPU:0;/job:localservice/replica:0/task:0/device:XLA_CPU:0&quot;</span> <span class="n">XRT_WORKERS</span><span class="o">=</span><span class="s2">&quot;localservice:0;grpc://localhost:51011&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="understanding-the-operation">
<h2>Understanding the operation<a class="headerlink" href="#understanding-the-operation" title="Permalink to this headline">¶</a></h2>
<p>You can find the definition of the C++ ATen operations in <a class="reference external" href="https://github.com/pytorch/pytorch/blob/master/aten/src/ATen/native/native_functions.yaml">native_functions.yaml</a>. After you build Pytorch/XLA from source, you will also find our default implementation (a boxed kernel which forwards calls to PyTorch native CPU) in <code class="docutils literal notranslate"><span class="pre">xla/torch_xla/csrc/aten_cpu_fallback.h/cpp</span></code>. Pytorch operations can usually be mapped to <a class="reference external" href="https://pytorch.org/docs/stable/index.html">PyTorch tensor api</a> easily. If that is not the case searching the PyTorch native implementation under <a class="reference external" href="https://github.com/pytorch/pytorch">PyTorch repo</a> is recommended. The goal is to lower the PyTorch operations into a sequence of XLA operations defined in <a class="reference external" href="https://www.tensorflow.org/xla/operation_semantics">here</a>.</p>
</div>
<div class="section" id="file-structure">
<h2>File structure<a class="headerlink" href="#file-structure" title="Permalink to this headline">¶</a></h2>
<p>All file mentioned below lives under the <code class="docutils literal notranslate"><span class="pre">xla/torch_xla/csrc</span></code> folder, with the exception of <code class="docutils literal notranslate"><span class="pre">xla_native_functions.yaml</span></code></p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">xla_native_functions.yaml</span></code> contains the list of all operators that are lowered. Each operator name must directly match a pytorch operator listed in <a class="reference external" href="https://github.com/pytorch/pytorch/blob/master/aten/src/ATen/native/native_functions.yaml">native_functions.yaml</a>. This file serves as the interface to adding new xla operators, and is an input to PyTorch’s <a class="reference external" href="https://github.com/pytorch/pytorch/blob/master/torchgen/gen_backend_stubs.py">codegen machinery</a>. It generates the below 3 files: <code class="docutils literal notranslate"><span class="pre">XLANativeFunctions.h</span></code>, <code class="docutils literal notranslate"><span class="pre">RegisterXLA.cpp</span></code>, and <code class="docutils literal notranslate"><span class="pre">RegisterAutogradXLA.cpp</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">XLANativeFunctions.h</span></code> and <code class="docutils literal notranslate"><span class="pre">aten_xla_type.cpp</span></code> are entry points of PyTorch to the pytorch_xla world, and contain the manually written lowerings to XLA for each operator. <code class="docutils literal notranslate"><span class="pre">XLANativeFunctions.h</span></code> is auto-generated through a combination of <code class="docutils literal notranslate"><span class="pre">xla_native_functions.yaml</span></code> and the PyTorch core <code class="docutils literal notranslate"><span class="pre">native_functions.yaml</span></code> file, and contains declarations for kernels that need to be defined in <code class="docutils literal notranslate"><span class="pre">aten_xla_type.cpp</span></code>. The kernels written here need to construct ‘XLATensor’ using the input <code class="docutils literal notranslate"><span class="pre">at::Tensor</span></code> and other parameters. The resulting <code class="docutils literal notranslate"><span class="pre">XLATensor</span></code> needs to be converted back to the <code class="docutils literal notranslate"><span class="pre">at::Tensor</span></code> before returning to the PyTorch world.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RegisterXLA.cpp</span></code> and <code class="docutils literal notranslate"><span class="pre">RegisterAutogradXLA.cpp</span></code> are auto-generated files that register all lowerings to the PyTorch Dispatcher. They also include auto-generated wrapper implementations of <code class="docutils literal notranslate"><span class="pre">out=</span></code> and <code class="docutils literal notranslate"><span class="pre">inplace</span></code> operators.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">aten_cpu_fallback.h/.cpp</span></code> contain our boxed fallback implementation to CPU. The boxed fallback kernel will be used if a lowering is not explicitly defined in <code class="docutils literal notranslate"><span class="pre">xla_native_functions.yaml</span></code> + <code class="docutils literal notranslate"><span class="pre">aten_xla_type.cpp</span></code>, and the operator is not composite.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tensor.h</span></code> contains the <code class="docutils literal notranslate"><span class="pre">XLATensor</span></code> declarations. These declarations are usually a one to one mapping of the <code class="docutils literal notranslate"><span class="pre">at::Tensor</span></code> nodes we declared in <code class="docutils literal notranslate"><span class="pre">XLANativeFunctions.h</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tensor_methods.cpp</span></code> contains the implementation of <code class="docutils literal notranslate"><span class="pre">XLATensor</span> <span class="pre">node</span></code> defined in <code class="docutils literal notranslate"><span class="pre">tensor.h</span></code>. We constructed the corresponding <code class="docutils literal notranslate"><span class="pre">ir::op</span></code> from the parameter’s <code class="docutils literal notranslate"><span class="pre">ir::Value</span></code> and wrapped it inside a <code class="docutils literal notranslate"><span class="pre">XLATensor</span></code>. Ir stands for intermediate representation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ops/</span></code> directory contains all <code class="docutils literal notranslate"><span class="pre">ir::ops</span></code> declaration and definition. Smaller nodes can be put in <code class="docutils literal notranslate"><span class="pre">ops/ops.h/.cpp</span></code>. More complicated nodes can be put into a separate file. All ops inherit from <code class="docutils literal notranslate"><span class="pre">ir::ops::Node</span></code> and provide a way to lower input <code class="docutils literal notranslate"><span class="pre">ir::Value</span></code> to a sequence of <code class="docutils literal notranslate"><span class="pre">XlaOp</span></code>.</p></li>
</ol>
</div>
<div class="section" id="unit-test">
<h2>Unit Test<a class="headerlink" href="#unit-test" title="Permalink to this headline">¶</a></h2>
<p>Our CircleCI runs PyTorch native python tests for every change and every day. Those tests will use XLA implementation if we provide a lowering. We usually don’t need to add additional python tests for PyTorch/XLA unless we want to verify some xla behaviors(like dynamic shape) or we skipped the pytorch native test for some reason. The python test should be added to <code class="docutils literal notranslate"><span class="pre">xla/test/test_operations.py</span></code> if it is required. We also need to add CPP tests in <code class="docutils literal notranslate"><span class="pre">xla/test/cpp/test_aten_xla_tensor.cpp</span></code>. This test should call PyTorch c++ API and verify our implementation yields the same result as PyTorch native implementation. We also need to verify if the xla implementation is called when the tensor is a XLA tensor by checking the <code class="docutils literal notranslate"><span class="pre">aten::op</span></code> and <code class="docutils literal notranslate"><span class="pre">xla::op</span></code> counters.</p>
</div>
<div class="section" id="tips">
<h2>Tips<a class="headerlink" href="#tips" title="Permalink to this headline">¶</a></h2>
<p>The process of lowering is breaking down the PyTorch operations into a sequence of XlaOp. To provide a good lowering of the PyTorch operation, one needs to have a good grasp of what XLA is capable of. Reading the XlaOp document and looking into how similar ops is lowered is the best way to achieve that. You can find a minimal Op lowering example in <a class="reference external" href="https://github.com/pytorch/xla/pull/2969">this pr</a>. You can also find a slightly more complicated example with backward lowering in <a class="reference external" href="https://github.com/pytorch/xla/pull/2972">this pr</a>.</p>
<p>We have auto-generated wrapper implementations of <code class="docutils literal notranslate"><span class="pre">out=</span></code> and <code class="docutils literal notranslate"><span class="pre">inplace</span></code> operators for some operators in <code class="docutils literal notranslate"><span class="pre">RegisterXLA.cpp</span></code>. We only need to lower the vanilla op in this case. An example would be <code class="docutils literal notranslate"><span class="pre">lerp</span></code> operator which has 6 variants in <code class="docutils literal notranslate"><span class="pre">native_functions.yaml</span></code>, they are</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">lerp_</span><span class="o">.</span><span class="n">Scalar</span>
<span class="o">-</span> <span class="n">lerp_</span><span class="o">.</span><span class="n">Tensor</span>
<span class="o">-</span> <span class="n">lerp</span><span class="o">.</span><span class="n">Scalar_out</span>
<span class="o">-</span> <span class="n">lerp</span><span class="o">.</span><span class="n">Tensor_out</span>
<span class="o">-</span> <span class="n">lerp</span><span class="o">.</span><span class="n">Scalar</span>
<span class="o">-</span> <span class="n">lerp</span><span class="o">.</span><span class="n">Tensor</span>
</pre></div>
</div>
<p>and will generate function prototypes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="n">lerp</span><span class="p">(</span><span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">,</span> <span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="n">end</span><span class="p">,</span> <span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Scalar</span> <span class="o">&amp;</span> <span class="n">weight</span><span class="p">);</span>
<span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="n">lerp_</span><span class="p">(</span><span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">,</span> <span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="n">end</span><span class="p">,</span> <span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Scalar</span> <span class="o">&amp;</span> <span class="n">weight</span><span class="p">);</span>
<span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="n">lerp</span><span class="p">(</span><span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">,</span> <span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="n">end</span><span class="p">,</span> <span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="n">weight</span><span class="p">);</span>
<span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="n">lerp_out</span><span class="p">(</span><span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">,</span> <span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="n">end</span><span class="p">,</span> <span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="n">weight</span><span class="p">,</span> <span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="n">out</span><span class="p">);</span>
<span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="n">lerp_</span><span class="p">(</span><span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">,</span> <span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="n">end</span><span class="p">,</span> <span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="n">weight</span><span class="p">);</span>
<span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="n">lerp_out</span><span class="p">(</span><span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">,</span> <span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="n">end</span><span class="p">,</span> <span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Scalar</span> <span class="o">&amp;</span> <span class="n">weight</span><span class="p">,</span> <span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="n">out</span><span class="p">);</span>
</pre></div>
</div>
<p>in <code class="docutils literal notranslate"><span class="pre">XLANativeFunctions.h</span></code> if we add all of them to the <code class="docutils literal notranslate"><span class="pre">xla_native_functions.yaml</span></code>. However if we only lower <code class="docutils literal notranslate"><span class="pre">lerp.Scalar</span></code> and <code class="docutils literal notranslate"><span class="pre">lerp.Tensor</span></code> and check <code class="docutils literal notranslate"><span class="pre">RegisterXLA.cpp</span></code>, we will see</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">namespace</span> <span class="p">{</span>

<span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="n">wrapper_Scalar_lerp</span><span class="p">(</span><span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">,</span> <span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="n">end</span><span class="p">,</span> <span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Scalar</span> <span class="o">&amp;</span> <span class="n">weight</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">No</span> <span class="n">device</span> <span class="n">check</span>


  <span class="o">//</span> <span class="n">DeviceGuard</span> <span class="n">omitted</span>
  <span class="k">return</span> <span class="n">torch_xla</span><span class="p">::</span><span class="n">lerp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">weight</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">}</span> <span class="o">//</span> <span class="n">anonymous</span> <span class="n">namespace</span>

<span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="n">wrapper_Scalar_lerp_</span><span class="p">(</span><span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="p">,</span> <span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Tensor</span> <span class="o">&amp;</span> <span class="n">end</span><span class="p">,</span> <span class="n">const</span> <span class="n">at</span><span class="p">::</span><span class="n">Scalar</span> <span class="o">&amp;</span> <span class="n">weight</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">auto</span> <span class="n">wrapper_Scalar_lerp__tmp</span> <span class="o">=</span> <span class="n">wrapper_Scalar_lerp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">weight</span><span class="p">);</span>
  <span class="n">at</span><span class="p">::</span><span class="n">_copy_from</span><span class="p">(</span><span class="n">wrapper_Scalar_lerp__tmp</span><span class="p">,</span> <span class="bp">self</span><span class="p">);</span>
  <span class="k">return</span> <span class="bp">self</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">...</span>
  <span class="n">m</span><span class="o">.</span><span class="n">impl</span><span class="p">(</span><span class="s2">&quot;lerp_.Scalar&quot;</span><span class="p">,</span>
  <span class="n">TORCH_FN</span><span class="p">(</span><span class="n">wrapper_Scalar_lerp_</span><span class="p">));</span>
</pre></div>
</div>
<p>The codegen will automatically generate lowerings for <code class="docutils literal notranslate"><span class="pre">lerp_.Scalar</span></code> and <code class="docutils literal notranslate"><span class="pre">lerp.Scalar_out</span></code> that use our <code class="docutils literal notranslate"><span class="pre">lerp.Scalar</span></code> implementation, without us having to provide an explicit lowering.</p>
<p>In general, if there is an operator in pytorch core that has both an out-of-place and an out= variant, it’s better to write a lowering for the out-of-place variant, since you’ll get a code-generated out= lowering for free.</p>
<p>For each node we need to pass an <code class="docutils literal notranslate"><span class="pre">ir::OpKind</span></code>. Here is an (<a class="reference external" href="https://github.com/pytorch/xla/blob/5ce99bff336325feb41a982dc80299fb53166b29/torch_xla/csrc/ops/var_mean.cpp#L36">example</a>). You can find the <code class="docutils literal notranslate"><span class="pre">OpKind</span></code> definition in <a class="reference external" href="https://github.com/pytorch/pytorch/blob/master/aten/src/ATen/core/aten_interned_strings.h">aten_interned_strings.h</a> or <a class="reference external" href="https://github.com/pytorch/pytorch/blob/master/aten/src/ATen/core/interned_strings.h">interned_strings.h</a>. If the aten symbol is missing, you can submit a PR like <a class="reference external" href="https://github.com/pytorch/pytorch/pull/36851">this</a>.</p>
</div>
</div>


             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright .

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              <ul>
<li><a class="reference internal" href="#">PyTorch on XLA Devices</a><ul>
<li><a class="reference internal" href="#creating-an-xla-tensor">Creating an XLA Tensor</a></li>
<li><a class="reference internal" href="#xla-tensors-are-pytorch-tensors">XLA Tensors are PyTorch Tensors</a></li>
<li><a class="reference internal" href="#running-models-on-xla-devices">Running Models on XLA Devices</a><ul>
<li><a class="reference internal" href="#running-on-a-single-xla-device">Running on a Single XLA Device</a></li>
<li><a class="reference internal" href="#running-on-multiple-xla-devices-with-multi-processing">Running on Multiple XLA Devices with Multi-processing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id1">XLA Tensor Deep Dive</a><ul>
<li><a class="reference internal" href="#xla-tensors-are-lazy">XLA Tensors are Lazy</a></li>
<li><a class="reference internal" href="#xla-tensors-and-bfloat16">XLA Tensors and bFloat16</a></li>
<li><a class="reference internal" href="#memory-layout">Memory Layout</a></li>
<li><a class="reference internal" href="#moving-xla-tensors-to-and-from-the-cpu">Moving XLA Tensors to and from the CPU</a></li>
<li><a class="reference internal" href="#saving-and-loading-xla-tensors">Saving and Loading XLA Tensors</a></li>
</ul>
</li>
<li><a class="reference internal" href="#further-reading">Further Reading</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pytorch-xla-api">PyTorch/XLA API</a><ul>
<li><a class="reference internal" href="#module-torch_xla.core.xla_model">xla_model</a></li>
<li><a class="reference internal" href="#module-torch_xla.distributed.parallel_loader">distributed</a></li>
<li><a class="reference internal" href="#module-torch_xla.utils.tf_record_reader">utils</a></li>
<li><a class="reference internal" href="#test">test</a></li>
</ul>
</li>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a><ul>
<li><a class="reference internal" href="#perform-a-auto-metrics-analysis">Perform A Auto-Metrics Analysis</a></li>
<li><a class="reference internal" href="#get-a-metrics-report">Get A Metrics Report</a></li>
<li><a class="reference internal" href="#understand-the-metrics-report">Understand The Metrics Report</a></li>
<li><a class="reference internal" href="#performance-profiling">Performance Profiling</a></li>
<li><a class="reference internal" href="#known-performance-caveats">Known Performance Caveats</a></li>
<li><a class="reference internal" href="#xla-tensor-quirks">XLA Tensor Quirks</a></li>
<li><a class="reference internal" href="#more-debugging-tools">More Debugging Tools</a><ul>
<li><a class="reference internal" href="#environment-variables">Environment Variables</a></li>
<li><a class="reference internal" href="#retrieving-stack-traces">Retrieving Stack Traces</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-debug-run-py-to-collect-debug-information">Using debug_run.py To Collect Debug Information</a></li>
<li><a class="reference internal" href="#common-issues">Common Issues</a></li>
</ul>
</li>
<li><a class="reference internal" href="#experimental-pjrt-runtime-support">Experimental PjRt Runtime Support</a><ul>
<li><a class="reference internal" href="#quickstart">Quickstart</a><ul>
<li><a class="reference internal" href="#cpu">CPU</a></li>
<li><a class="reference internal" href="#v4-tpu">v4 TPU</a><ul>
<li><a class="reference internal" href="#pods">Pods</a></li>
</ul>
</li>
<li><a class="reference internal" href="#gpu">GPU</a></li>
</ul>
</li>
<li><a class="reference internal" href="#key-differences-from-xrt">Key differences from XRT</a></li>
<li><a class="reference internal" href="#tpus-v2-v3-vs-v4">TPUs v2/v3 vs v4</a><ul>
<li><a class="reference internal" href="#compatible-examples">Compatible examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pjrt-and-ddp">PjRt and DDP</a></li>
</ul>
</li>
<li><a class="reference internal" href="#how-to-do-distributeddataparallel">How to do <code class="docutils literal notranslate"><span class="pre">DistributedDataParallel</span></code></a><ul>
<li><a class="reference internal" href="#background-motivation">Background / Motivation</a></li>
<li><a class="reference internal" href="#how-to-use-distributeddataparallel">How to use DistributedDataParallel</a></li>
<li><a class="reference internal" href="#benchmarking">Benchmarking</a><ul>
<li><a class="reference internal" href="#resnet50-with-fake-data">Resnet50 with fake data</a></li>
<li><a class="reference internal" href="#mnist-with-fake-data">MNIST with fake data</a></li>
<li><a class="reference internal" href="#mnist-with-real-data">MNIST with real data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#disclaimer">Disclaimer</a></li>
<li><a class="reference internal" href="#fully-sharded-data-parallel-fsdp-in-pytorch-xla">Fully Sharded Data Parallel (FSDP) in PyTorch XLA</a><ul>
<li><a class="reference internal" href="#example-training-scripts-on-mnist-and-imagenet">Example training scripts on MNIST and ImageNet</a><ul>
<li><a class="reference internal" href="#installation">Installation</a></li>
<li><a class="reference internal" href="#clone-pytorch-xla-repo">Clone PyTorch/XLA repo</a></li>
<li><a class="reference internal" href="#train-mnist-on-v3-8-tpu">Train MNIST on v3-8 TPU</a></li>
<li><a class="reference internal" href="#train-imagenet-with-resnet-50-on-v3-8-tpu">Train ImageNet with ResNet-50 on v3-8 TPU</a></li>
</ul>
</li>
<li><a class="reference internal" href="#example-training-scripts-on-tpu-pod-with-10-billion-parameters">Example training scripts on TPU pod (with 10 billion parameters)</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#op-lowering-guide">OP Lowering Guide</a><ul>
<li><a class="reference internal" href="#background">Background</a></li>
<li><a class="reference internal" href="#before-you-start">Before you start</a></li>
<li><a class="reference internal" href="#understanding-the-operation">Understanding the operation</a></li>
<li><a class="reference internal" href="#file-structure">File structure</a></li>
<li><a class="reference internal" href="#unit-test">Unit Test</a></li>
<li><a class="reference internal" href="#tips">Tips</a></li>
</ul>
</li>
</ul>

            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
         <script src="_static/jquery.js"></script>
         <script src="_static/underscore.js"></script>
         <script src="_static/doctools.js"></script>
         <script src="_static/language_data.js"></script>
     

  

  <script type="text/javascript" src="_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">Stay up to date</li>
            <li><a href="https://www.facebook.com/pytorch" target="_blank">Facebook</a></li>
            <li><a href="https://twitter.com/pytorch" target="_blank">Twitter</a></li>
            <li><a href="https://www.youtube.com/pytorch" target="_blank">YouTube</a></li>
            <li><a href="https://www.linkedin.com/company/pytorch" target="_blank">LinkedIn</a></li>
          </ul>  
          </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title">PyTorch Podcasts</li>
            <li><a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">Spotify</a></li>
            <li><a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">Apple</a></li>
            <li><a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">Google</a></li>
            <li><a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">Amazon</a></li>
          </ul>
         </div>
        </div>
        
        <div class="privacy-policy">
          <ul>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/terms/" target="_blank">Terms</a></li>
            <li class="privacy-policy-links">|</li>
            <li class="privacy-policy-links"><a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">Privacy</a></li>
          </ul>
        </div>
        <div class="copyright">
        <p>© Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
          <a href="www.linuxfoundation.org/policies/">www.linuxfoundation.org/policies/</a>. The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see <a href="www.lfprojects.org/policies/">www.lfprojects.org/policies/</a>.</p>
      </div>
     </div>

  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>
            
          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title" class="active">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/torcharrow">torcharrow</a>
            </li>

            <li>
              <a href="https://pytorch.org/data">TorchData</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchrec">TorchRec</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/torchx/">TorchX</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>
            
           <ul class="resources-mobile-menu-items">

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/foundation">PyTorch Foundation</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://pytorch.org/community-stories">Community Stories</a>
            </li>

            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/events">Events</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>